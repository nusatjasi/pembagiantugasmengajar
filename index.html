<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiJAB SMP N 2 WERT - Aplikasi Pembagian Tugas Mengajar</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Konfigurasi Tailwind untuk Font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Inter Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import {
            Plus, Trash2, Save, Calendar, Users, BookOpen,
            AlertCircle, CheckCircle, GraduationCap, Clock,
            FileText, Printer, Edit2, X, Home, Grid, Layers,
            Layout, Settings, ChevronDown, ChevronRight, RefreshCw,
            ClipboardList, AlertTriangle, FileSignature, Briefcase, Award, Coffee, Info, CheckSquare, Tag, Eye,
            ShieldCheck, Menu, Database, BarChart3, Target, LogOut, EyeOff, Lock
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://cxswdplrojgqlhxfavpd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4c3dkcGxyb2phcWxoeGZhdnBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDM4NDgsImV4cCI6MjA3OTcxOTg0OH0.roWFwvGZLxs_auqVow6vxi4s_2z3QJeOv6uNtJk0jP0';

        // Gunakan library yang dimuat lewat tag script (Global)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- KODE APLIKASI ---

        const DEFAULT_MAPEL_DAPODIK = [
            { id: 'mpl-1', name: 'Pendidikan Agama dan Budi Pekerti', code: 'PABP' },
            { id: 'mpl-2', name: 'Pendidikan Pancasila (PKn)', code: 'PKN' },
            { id: 'mpl-3', name: 'Bahasa Indonesia', code: 'BIN' },
            { id: 'mpl-4', name: 'Matematika', code: 'MTK' },
            { id: 'mpl-5', name: 'Ilmu Pengetahuan Alam (IPA)', code: 'IPA' },
            { id: 'mpl-6', name: 'Ilmu Pengetahuan Sosial (IPS)', code: 'IPS' },
            { id: 'mpl-7', name: 'Bahasa Inggris', code: 'ING' },
            { id: 'mpl-8', name: 'Seni Budaya', code: 'SBY' },
            { id: 'mpl-9', name: 'PJOK', code: 'PJOK' },
            { id: 'mpl-10', name: 'Informatika', code: 'INF' },
            { id: 'mpl-11', name: 'Prakarya', code: 'PKY' },
            { id: 'mpl-12', name: 'Bahasa Daerah', code: 'MULOK' },
            { id: 'mpl-13', name: 'Bimbingan Konseling (BK)', code: 'BK' }
        ];

        const DEFAULT_DAYS = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
        const PIKET_DAYS = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const DEFAULT_PERIOD_COUNT = 10;

        // --- KOMPONEN UTAMA ---

        function App() {
            // --- STATE MANAGEMENT ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [expandedMenu, setExpandedMenu] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(() => {
                const saved = localStorage.getItem('smp_is_logged_in');
                return saved === 'true';
            });

            // Loading & Animation States
            const [isLoading, setIsLoading] = useState(true);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [loadingText, setLoadingText] = useState('');
            const [copyItems, setCopyItems] = useState([]);
            const [isEnteringDashboard, setIsEnteringDashboard] = useState(false);
            const [isExiting, setIsExiting] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSyncTime, setLastSyncTime] = useState(null);

            useEffect(() => {
                localStorage.setItem('smp_is_logged_in', isLoggedIn);
            }, [isLoggedIn]);

            const [showPassword, setShowPassword] = useState(false);
            const [showSettingsPassword, setShowSettingsPassword] = useState(false);

            const [adminCredentials, setAdminCredentials] = useState(() => {
                const saved = localStorage.getItem('smp_admin_credentials');
                return saved ? JSON.parse(saved) : {
                    username: 'admin',
                    password: '123'
                };
            });

            // Sidebar States
            const [isSidebarOpen, setIsSidebarOpen] = useState(true); // True = Expanded, False = Collapsed/Hidden
            const [isMobile, setIsMobile] = useState(false);

            // Handle Resize
            useEffect(() => {
                const handleResize = () => {
                    const mobile = window.innerWidth < 1024;
                    setIsMobile(mobile);
                    if (mobile) {
                        setIsSidebarOpen(false); // Default closed on mobile
                    } else {
                        setIsSidebarOpen(true); // Default open on desktop
                    }
                };
                handleResize();
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Data Sekolah
            const [schoolProfile, setSchoolProfile] = useState(() => {
                const saved = localStorage.getItem('smp_school_profile');
                return saved ? JSON.parse(saved) : {
                    name: 'SMP NEGERI 2 WERT',
                    address: 'Alamat Sekolah Anda Disini',
                    headerTitle: 'JADWAL PELAJARAN TAHUN AJARAN 2026/2027',
                    appName: 'SiJAB SMP N 2 WERT',
                    academicYear: '2026/2027'
                };
            });

            // Data Master Tambahan
            const [tugasTambahanList, setTugasTambahanList] = useState(() => {
                const saved = localStorage.getItem('smp_master_tugas');
                return saved ? JSON.parse(saved) : [
                    { id: 'tt-1', name: 'Kepala Sekolah', hours: 24 },
                    { id: 'tt-2', name: 'Wakil Kepala Sekolah', hours: 12 },
                    { id: 'tt-3', name: 'Kepala Perpustakaan', hours: 12 },
                    { id: 'tt-4', name: 'Kepala Laboratorium', hours: 12 }
                ];
            });

            const [pembinaList, setPembinaList] = useState(() => {
                const saved = localStorage.getItem('smp_master_pembina');
                return saved ? JSON.parse(saved) : [
                    { id: 'pb-1', name: 'Pembina OSIS', hours: 2 },
                    { id: 'pb-2', name: 'Pembina Pramuka', hours: 2 },
                    { id: 'pb-3', name: 'Pembina PMR', hours: 2 },
                    { id: 'pb-4', name: 'Pembina Rohis', hours: 2 }
                ];
            });

            // Master Nama Rombel
            const [masterRombelNames, setMasterRombelNames] = useState(() => {
                const saved = localStorage.getItem('smp_master_rombel_names');
                return saved ? JSON.parse(saved) : [
                    { id: 'rn-1', name: 'Kelas VII-A' },
                    { id: 'rn-2', name: 'Kelas VII-B' },
                    { id: 'rn-3', name: 'Kelas VIII-A' },
                    { id: 'rn-4', name: 'Kelas VIII-B' },
                    { id: 'rn-5', name: 'Kelas IX-A' },
                    { id: 'rn-6', name: 'Kelas IX-B' },
                ];
            });

            // Data Guru
            const [teachers, setTeachers] = useState(() => {
                const saved = localStorage.getItem('smp_teachers');
                return saved ? JSON.parse(saved) : [];
            });

            const [subjects, setSubjects] = useState(() => {
                const saved = localStorage.getItem('smp_subjects');
                return saved ? JSON.parse(saved) : DEFAULT_MAPEL_DAPODIK;
            });

            const [rooms, setRooms] = useState(() => {
                const saved = localStorage.getItem('smp_rooms');
                return saved ? JSON.parse(saved) : [
                    { id: 'r-1', name: 'Ruang Teori 1' },
                    { id: 'r-2', name: 'Ruang Teori 2' },
                    { id: 'r-3', name: 'Ruang Teori 3' },
                    { id: 'r-4', name: 'Lab Komputer' },
                    { id: 'r-5', name: 'Lab IPA' }
                ];
            });

            const [curriculums, setCurriculums] = useState(() => {
                const saved = localStorage.getItem('smp_curriculums');
                return saved ? JSON.parse(saved) : [
                    { id: 'k-1', name: 'Kurikulum Merdeka' },
                    { id: 'k-2', name: 'Kurikulum 2013 (K13)' }
                ];
            });

            const [classes, setClasses] = useState(() => {
                const saved = localStorage.getItem('smp_classes');
                return saved ? JSON.parse(saved) : [];
            });

            // Guru Piket
            const [picketSchedule, setPicketSchedule] = useState(() => {
                const saved = localStorage.getItem('smp_picket');
                return saved ? JSON.parse(saved) : {};
            });

            // Master Piket Hours
            const [picketLoad, setPicketLoad] = useState(() => {
                const saved = localStorage.getItem('smp_picket_load');
                return saved ? parseInt(saved) : 1;
            });

            // Master Maximal Jam
            const [maxHourSettings, setMaxHourSettings] = useState(() => {
                const saved = localStorage.getItem('smp_max_hours');
                return saved ? JSON.parse(saved) : {};
            });

            // Master SK Mengajar
            const [masterSK, setMasterSK] = useState(() => {
                const saved = localStorage.getItem('smp_master_sk');
                return saved ? JSON.parse(saved) : { number: '', date: '', semester: '2026/2027' };
            });

            // Master Pangkat/Golongan
            const [pangkatGolonganList, setPangkatGolonganList] = useState(() => {
                const saved = localStorage.getItem('smp_master_pangkat');
                return saved ? JSON.parse(saved) : [
                    { id: 'pg-1', name: 'I/a' },
                    { id: 'pg-2', name: 'I/b' },
                    { id: 'pg-3', name: 'I/c' },
                    { id: 'pg-4', name: 'I/d' },
                    { id: 'pg-5', name: 'II/a' },
                    { id: 'pg-6', name: 'II/b' },
                    { id: 'pg-7', name: 'II/c' },
                    { id: 'pg-8', name: 'II/d' },
                    { id: 'pg-9', name: 'III/a' },
                    { id: 'pg-10', name: 'III/b' },
                    { id: 'pg-11', name: 'III/c' },
                    { id: 'pg-12', name: 'III/d' },
                    { id: 'pg-13', name: 'IV/a' },
                    { id: 'pg-14', name: 'IV/b' },
                    { id: 'pg-15', name: 'IV/c' },
                    { id: 'pg-16', name: 'IV/d' },
                    { id: 'pg-17', name: 'IV/e' },
                ];
            });

            // Allocations (Pembelajaran)
            const [allocations, setAllocations] = useState(() => {
                const saved = localStorage.getItem('smp_allocations');
                return saved ? JSON.parse(saved) : [];
            });

            const [periodTimes, setPeriodTimes] = useState(() => {
                const saved = localStorage.getItem('smp_periods');
                if (saved) return JSON.parse(saved);
                let times = [];
                for (let i = 0; i < DEFAULT_PERIOD_COUNT; i++) times.push({ id: i, time: '00.00 - 00.00' });
                times[0].time = '07.00 - 07.40';
                return times;
            });

            const [schedules, setSchedules] = useState(() => {
                const saved = localStorage.getItem('smp_schedules');
                return saved ? JSON.parse(saved) : [];
            });

            // --- UI STATES ---
            const [selectedClassId, setSelectedClassId] = useState('');
            const [modalOpen, setModalOpen] = useState(false);
            const [editingSlot, setEditingSlot] = useState(null);
            const [formData, setFormData] = useState({ subjectId: '', teacherId: '' });
            const [errorMsg, setErrorMsg] = useState('');

            // State Form Rombel
            const [rombelForm, setRombelForm] = useState({
                id: '', name: '', level: '7', type: 'Kelas', curriculum: '', teacherId: '', roomId: ''
            });
            const [selectedRombelRow, setSelectedRombelRow] = useState(null);
            const [isEditingRombel, setIsEditingRombel] = useState(false);

            // State Modal Pembelajaran
            const [learningModalOpen, setLearningModalOpen] = useState(false);
            const [activeLearningClass, setActiveLearningClass] = useState(null);

            // State Modal Guru
            const [guruModalOpen, setGuruModalOpen] = useState(false);
            const [guruModalMode, setGuruModalMode] = useState('view');
            const [selectedGuru, setSelectedGuru] = useState(null);

            // State Modal Rombel View
            const [rombelViewModalOpen, setRombelViewModalOpen] = useState(false);
            const [selectedRombelView, setSelectedRombelView] = useState(null);

            // State Edit Master
            const [editMasterItem, setEditMasterItem] = useState(null);
            const [isMasterModalOpen, setIsMasterModalOpen] = useState(false);
            // State Notifikasi (Toast)
            const [toast, setToast] = useState({ msg: '', type: 'info', visible: false });
            const [confirmModal, setConfirmModal] = useState({ visible: false, message: '', onConfirm: null });

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type, visible: true });
                setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3000);
            };

            const askConfirm = (message, onConfirm) => {
                setConfirmModal({ visible: true, message, onConfirm });
            };

            const closeConfirm = () => setConfirmModal({ visible: false, message: '', onConfirm: null });

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('smp_teachers', JSON.stringify(teachers));
                pushToCloud('smp_teachers', teachers);
            }, [teachers]);
            useEffect(() => {
                localStorage.setItem('smp_classes', JSON.stringify(classes));
                pushToCloud('smp_classes', classes);
            }, [classes]);
            useEffect(() => {
                localStorage.setItem('smp_subjects', JSON.stringify(subjects));
                pushToCloud('smp_subjects', subjects);
            }, [subjects]);
            useEffect(() => {
                localStorage.setItem('smp_rooms', JSON.stringify(rooms));
                pushToCloud('smp_rooms', rooms);
            }, [rooms]);
            useEffect(() => {
                localStorage.setItem('smp_curriculums', JSON.stringify(curriculums));
                pushToCloud('smp_curriculums', curriculums);
            }, [curriculums]);
            useEffect(() => {
                localStorage.setItem('smp_periods', JSON.stringify(periodTimes));
                pushToCloud('smp_periods', periodTimes);
            }, [periodTimes]);
            useEffect(() => {
                localStorage.setItem('smp_schedules', JSON.stringify(schedules));
                pushToCloud('smp_schedules', schedules);
            }, [schedules]);
            useEffect(() => {
                localStorage.setItem('smp_allocations', JSON.stringify(allocations));
                pushToCloud('smp_allocations', allocations);
            }, [allocations]);
            useEffect(() => {
                localStorage.setItem('smp_max_hours', JSON.stringify(maxHourSettings));
                pushToCloud('smp_max_hours', maxHourSettings);
            }, [maxHourSettings]);
            useEffect(() => {
                localStorage.setItem('smp_master_sk', JSON.stringify(masterSK));
                pushToCloud('smp_master_sk', masterSK);
            }, [masterSK]);
            useEffect(() => {
                localStorage.setItem('smp_master_tugas', JSON.stringify(tugasTambahanList));
                pushToCloud('smp_master_tugas', tugasTambahanList);
            }, [tugasTambahanList]);
            useEffect(() => {
                localStorage.setItem('smp_master_pembina', JSON.stringify(pembinaList));
                pushToCloud('smp_master_pembina', pembinaList);
            }, [pembinaList]);
            useEffect(() => {
                localStorage.setItem('smp_picket', JSON.stringify(picketSchedule));
                pushToCloud('smp_picket', picketSchedule);
            }, [picketSchedule]);
            useEffect(() => {
                localStorage.setItem('smp_master_rombel_names', JSON.stringify(masterRombelNames));
                pushToCloud('smp_master_rombel_names', masterRombelNames);
            }, [masterRombelNames]);
            useEffect(() => {
                localStorage.setItem('smp_picket_load', picketLoad);
                pushToCloud('smp_picket_load', picketLoad);
            }, [picketLoad]);
            useEffect(() => {
                localStorage.setItem('smp_school_profile', JSON.stringify(schoolProfile));
                pushToCloud('smp_school_profile', schoolProfile);
            }, [schoolProfile]);
            useEffect(() => {
                localStorage.setItem('smp_master_pangkat', JSON.stringify(pangkatGolonganList));
                pushToCloud('smp_master_pangkat', pangkatGolonganList);
            }, [pangkatGolonganList]);

            const pushToCloud = async (key, data) => {
                if (!isLoggedIn) return;
                try {
                    setIsSyncing(true);
                    const { error } = await supabase
                        .from('app_storage')
                        .upsert({
                            id: key,
                            content: data,
                            updated_at: new Date().toISOString()
                        });

                    if (error) {
                        console.error('Supabase Error:', error);
                        showToast(`Gagal kirim ke Cloud: ${error.message}`, 'error');
                    }
                    setLastSyncTime(new Date());
                } catch (e) {
                    console.error('Push error:', e);
                } finally {
                    setIsSyncing(false);
                }
            };

            const fetchFromCloud = async () => {
                if (!isLoggedIn) return;
                try {
                    setIsSyncing(true);
                    const { data, error } = await supabase.from('app_storage').select('*');
                    if (error) throw error;

                    if (data && data.length > 0) {
                        data.forEach(item => {
                            switch (item.id) {
                                case 'smp_teachers': setTeachers(item.content); break;
                                case 'smp_classes': setClasses(item.content); break;
                                case 'smp_subjects': setSubjects(item.content); break;
                                case 'smp_rooms': setRooms(item.content); break;
                                case 'smp_curriculums': setCurriculums(item.content); break;
                                case 'smp_periods': setPeriodTimes(item.content); break;
                                case 'smp_schedules': setSchedules(item.content); break;
                                case 'smp_allocations': setAllocations(item.content); break;
                                case 'smp_max_hours': setMaxHourSettings(item.content); break;
                                case 'smp_master_sk': setMasterSK(item.content); break;
                                case 'smp_master_tugas': setTugasTambahanList(item.content); break;
                                case 'smp_master_pembina': setPembinaList(item.content); break;
                                case 'smp_picket': setPicketSchedule(item.content); break;
                                case 'smp_master_rombel_names': setMasterRombelNames(item.content); break;
                                case 'smp_picket_load': setPicketLoad(item.content); break;
                                case 'smp_school_profile': setSchoolProfile(item.content); break;
                                case 'smp_master_pangkat': setPangkatGolonganList(item.content); break;
                            }
                        });
                        showToast('Data berhasil disinkronkan dari Cloud', 'info');
                    }
                } catch (e) {
                    console.error('Fetch error:', e);
                    // Mute error toast on initial load to prevent annoyance
                    // showToast(`Gagal sinkron awan: ${e.message || 'Cek koneksi'}`, 'error');
                } finally {
                    setIsSyncing(false);
                }
            };

            useEffect(() => {
                if (isLoggedIn) fetchFromCloud();
            }, [isLoggedIn]);

            const testConnection = async () => {
                try {
                    showToast('Sedang mengetes koneksi...', 'info');
                    const { data, error } = await supabase.from('app_storage').select('id').limit(1);
                    if (error) throw error;
                    showToast('Koneksi Supabase BERHASIL! Database siap digunakan.', 'success');
                } catch (e) {
                    console.error('Test Connection Error:', e);
                    showToast(`Koneksi GAGAL: ${e.message}`, 'error');
                    if (e.message === 'Failed to fetch') {
                        alert('Pesan "Failed to fetch" biasanya berarti koneksi Anda diblokir. \n\nTips: \n1. Gunakan Live Server (Go Live) di VS Code. \n2. Matikan AdBlock/VPN. \n3. Pastikan internet aktif.');
                    }
                }
            };

            useEffect(() => {
                if (classes.length > 0 && !selectedClassId) setSelectedClassId(classes[0].id);
            }, [classes, selectedClassId]);

            // Effect: Loading Simulation (Copy Data style)
            useEffect(() => {
                if (isLoggedIn) {
                    setIsLoading(false);
                    return;
                }

                const items = [
                    'Membaca konfiguasi sekolah...',
                    'Sinkronisasi data guru...',
                    'Menyiapkan master kurikulum...',
                    'Memuat basis data rombel...',
                    'Verifikasi modul pembelajaran...',
                    'Mengoptimalkan jadwal...',
                    'Siap melayani...'
                ];

                let currentIdx = 0;
                let progress = 0;

                const interval = setInterval(() => {
                    progress += Math.floor(Math.random() * 15) + 5;
                    if (progress >= 100) {
                        progress = 100;
                        setLoadingProgress(100);
                        setTimeout(() => setIsLoading(false), 800);
                        clearInterval(interval);
                    } else {
                        setLoadingProgress(progress);
                        if (progress > (currentIdx + 1) * (100 / items.length)) {
                            currentIdx++;
                        }
                        setLoadingText(items[currentIdx] || items[items.length - 1]);
                        setCopyItems(prev => {
                            const newItems = [...prev];
                            if (newItems[newItems.length - 1] !== items[currentIdx]) {
                                newItems.push(items[currentIdx]);
                            }
                            return newItems.slice(-3);
                        });
                    }
                }, 400);

                return () => clearInterval(interval);
            }, [isLoggedIn]);

            // --- LOGIC FUNCTIONS (Masters) ---

            const deleteItem = (setter, list, id) => {
                askConfirm('Apakah Anda yakin ingin menghapus data ini?', () => {
                    setter(list.filter(item => item.id !== id));
                    if (editMasterItem && editMasterItem.data?.id === id) setEditMasterItem(null);
                    showToast('Data berhasil dihapus', 'success');
                    closeConfirm();
                });
            };

            const startEditMaster = (type, item) => {
                setEditMasterItem({ type, data: item });
                setIsMasterModalOpen(true);
            };

            const handleAddNewMaster = (type) => {
                setEditMasterItem({ type, data: null });
                setIsMasterModalOpen(true);
            };

            const cancelEditMaster = () => {
                setEditMasterItem(null);
                setIsMasterModalOpen(false);
            };

            const handleSaveMasterSimple = (e, setter, list, type) => {
                e.preventDefault();
                const val = e.target.val.value;
                if (!val) return;

                if (editMasterItem && editMasterItem.type === type && editMasterItem.data) {
                    setter(list.map(item => item.id === editMasterItem.data.id ? { ...item, name: val } : item));
                    setEditMasterItem(null);
                    showToast('Data berhasil diperbarui');
                } else {
                    setter([...list, { id: Date.now().toString(), name: val }]);
                    showToast('Data baru berhasil ditambahkan');
                }
                setIsMasterModalOpen(false);
                e.target.reset();
            };

            const handleSaveMasterAssignment = (e, setter, list, type) => {
                e.preventDefault();
                const name = e.target.name.value;
                const hours = e.target.hours.value;
                if (!name) return;

                if (editMasterItem && editMasterItem.type === type && editMasterItem.data) {
                    setter(list.map(item => item.id === editMasterItem.data.id ? { ...item, name, hours: parseInt(hours) || 0 } : item));
                    setEditMasterItem(null);
                    showToast('Data berhasil diperbarui');
                } else {
                    setter([...list, { id: Date.now().toString(), name, hours: parseInt(hours) || 0 }]);
                    showToast('Data baru berhasil ditambahkan');
                }
                setIsMasterModalOpen(false);
                e.target.reset();
            };

            const handleSaveMasterMapel = (e) => {
                e.preventDefault();
                const name = e.target.mapelName.value;
                const code = e.target.mapelCode.value;
                if (!name || !code) return;

                if (editMasterItem && editMasterItem.type === 'mapel' && editMasterItem.data) {
                    setSubjects(subjects.map(s => s.id === editMasterItem.data.id ? { ...s, name, code } : s));
                    setEditMasterItem(null);
                    showToast('Data Mata Pelajaran diperbarui');
                } else {
                    setSubjects([...subjects, { id: Date.now().toString(), name, code }]);
                    showToast('Mata Pelajaran baru ditambahkan');
                }
                setIsMasterModalOpen(false);
                e.target.reset();
            };

            // --- LOGIC ROMBEL ---
            const resetRombelForm = () => {
                setRombelForm({
                    id: '', name: '', level: '7', type: 'Kelas', curriculum: curriculums[0]?.name || '', teacherId: '', roomId: ''
                });
                setSelectedRombelRow(null);
                setIsEditingRombel(false);
            };

            const handleSelectRombelRow = (cls) => {
                setRombelForm({ ...cls });
                setSelectedRombelRow(cls.id);
                setIsEditingRombel(true);
            };

            const handleTambahRombel = () => {
                resetRombelForm();
                // Override reset behavior just for this button to SHOW the form
                setTimeout(() => setIsEditingRombel(true), 0);
            }

            const handleSaveRombel = () => {
                if (!rombelForm.name) {
                    showToast("Nama Rombel wajib diisi", "error");
                    return;
                }
                if (selectedRombelRow && isEditingRombel) {
                    handleUpdateRombel();
                    return;
                }
                const newId = Date.now().toString();
                const newClass = { ...rombelForm, id: newId };
                setClasses([...classes, newClass]);
                setSelectedRombelRow(newId);
                setIsEditingRombel(false);
                showToast("Data Rombel baru berhasil disimpan.");
            };

            const handleUpdateRombel = () => {
                if (!selectedRombelRow) return;
                if (!rombelForm.name) { showToast("Nama Rombel wajib diisi", "error"); return; }
                setClasses(classes.map(c => c.id === selectedRombelRow ? { ...rombelForm, id: selectedRombelRow } : c));
                setIsEditingRombel(false);
                showToast("Perubahan Data Rombel berhasil disimpan.");
            }

            const handleDeleteRombel = (id) => {
                askConfirm("Apakah Anda yakin ingin menghapus Data Rombel ini?", () => {
                    const newClasses = classes.filter(c => c.id !== id);
                    setClasses(newClasses);
                    if (selectedRombelRow === id) {
                        resetRombelForm();
                    }
                    showToast("Data Rombel berhasil dihapus.");
                    closeConfirm();
                });
            };

            const handleViewRombel = (rombel) => {
                setSelectedRombelView(rombel);
                setRombelViewModalOpen(true);
            }

            const getRomanLevel = (level) => {
                if (level === '7') return 'VII';
                if (level === '8') return 'VIII';
                if (level === '9') return 'IX';
                return '';
            }

            // --- LOGIC GURU ---
            const handleAddTeacher = (e) => {
                e.preventDefault();
                const form = e.target;
                const newTeacher = {
                    id: Date.now().toString(),
                    name: form.name.value,
                    nip: form.nip.value,
                    rank: form.rank.value,
                    code: form.code.value,
                    tugasTambahanId: form.tugasTambahanId.value,
                    pembinaId: form.pembinaId.value
                };
                if (newTeacher.name && newTeacher.code) {
                    setTeachers([...teachers, newTeacher]);
                    form.reset();
                }
            };

            const openGuruModal = (mode, guru) => {
                setGuruModalMode(mode);
                setSelectedGuru(guru ? { ...guru } : null);
                setGuruModalOpen(true);
            }

            const handleSaveGuruEdit = (e) => {
                e.preventDefault();
                const form = e.target;
                const guruData = {
                    name: form.name.value,
                    nip: form.nip.value,
                    rank: form.rank.value,
                    code: form.code.value,
                    tugasTambahanId: form.tugasTambahanId.value,
                    pembinaId: form.pembinaId.value
                };

                if (selectedGuru && selectedGuru.id) {
                    setTeachers(teachers.map(t => t.id === selectedGuru.id ? { ...selectedGuru, ...guruData } : t));
                    showToast("Data Guru berhasil diperbarui");
                } else {
                    setTeachers([...teachers, { ...guruData, id: Date.now().toString() }]);
                    showToast("Guru baru berhasil ditambahkan");
                }
                setGuruModalOpen(false);
            };

            // --- LOGIC MASTER MAX JAM ---
            const handleUpdateMaxHour = (subjectId, val) => {
                const newVal = parseInt(val) || 0;
                setMaxHourSettings(prev => ({ ...prev, [subjectId]: newVal }));
            }

            // --- LOGIC PEMBELAJARAN ---
            const handleOpenLearning = () => {
                if (!selectedRombelRow) {
                    showToast("Harap pilih salah satu Rombel di tabel terlebih dahulu (klik baris tabel).", "info");
                    return;
                }
                setActiveLearningClass(selectedRombelRow);
                setLearningModalOpen(true);
            };

            const handleUpdateAllocation = (subjectId, field, value) => {
                if (field === 'hours') {
                    const maxVal = maxHourSettings[subjectId] || 0;
                    const inputVal = parseInt(value) || 0;
                    if (maxVal > 0 && inputVal > maxVal) {
                        showToast(`Gagal! Jam tatap muka (${inputVal} JP) melebihi Batas Maksimal Master (${maxVal} JP).`, "error");
                        return;
                    }
                }

                const existingIndex = allocations.findIndex(a => a.classId === activeLearningClass && a.subjectId === subjectId);
                let newAllocations = [...allocations];

                if (existingIndex > -1) {
                    newAllocations[existingIndex] = { ...newAllocations[existingIndex], [field]: value };
                } else {
                    const newAlloc = {
                        id: Date.now().toString() + Math.random(),
                        classId: activeLearningClass,
                        subjectId: subjectId,
                        teacherId: '',
                        skNumber: masterSK.number || '',
                        skDate: masterSK.date || '',
                        hours: '',
                        maxHours: '',
                    };
                    newAlloc[field] = value;
                    newAllocations.push(newAlloc);
                }
                setAllocations(newAllocations);
            };

            // --- LOGIC GURU PIKET ---
            const handlePicketChange = (teacherId, day) => {
                if (day === "") {
                    const newSchedule = { ...picketSchedule };
                    delete newSchedule[teacherId];
                    setPicketSchedule(newSchedule);
                } else {
                    setPicketSchedule(prev => ({
                        ...prev,
                        [teacherId]: day
                    }));
                }
            };

            const handleAddSubject = (e) => {
                e.preventDefault();
                const name = e.target.mapelName.value;
                const code = e.target.mapelCode.value;
                if (name && code) {
                    setSubjects([...subjects, { id: Date.now().toString(), name, code }]);
                    e.target.reset();
                }
            }

            const handleSaveSchedule = () => {
                setErrorMsg('');
                if (!formData.subjectId) { setErrorMsg('Pilih Mata Pelajaran dahulu.'); return; }
                if (formData.teacherId) {
                    const conflict = checkConflict(selectedClassId, editingSlot.dayIndex, editingSlot.periodIndex, formData.teacherId);
                    if (conflict) { setErrorMsg(conflict); return; }
                }
                const newSchedules = schedules.filter(s =>
                    !(s.classId === selectedClassId && s.dayIndex === editingSlot.dayIndex && s.periodIndex === editingSlot.periodIndex)
                );
                newSchedules.push({
                    id: Date.now().toString(), classId: selectedClassId, dayIndex: editingSlot.dayIndex,
                    periodIndex: editingSlot.periodIndex, subjectId: formData.subjectId, teacherId: formData.teacherId
                });
                setSchedules(newSchedules);
                setModalOpen(false);
                setFormData({ subjectId: '', teacherId: '' });
            };

            const checkConflict = (classId, dayIdx, periodIdx, teacherId) => {
                const teacherConflict = schedules.find(s =>
                    s.teacherId === teacherId && s.dayIndex === dayIdx && s.periodIndex === periodIdx && s.classId !== classId
                );
                if (teacherConflict) {
                    const className = classes.find(c => c.id === teacherConflict.classId)?.name;
                    return `BENTROK: Guru ini sedang mengajar di kelas ${className || 'Lain'}.`;
                }
                return null;
            };

            const handleDeleteScheduleSlot = () => {
                setSchedules(schedules.filter(s => !(s.classId === selectedClassId && s.dayIndex === editingSlot.dayIndex && s.periodIndex === editingSlot.periodIndex)));
                setModalOpen(false);
            }

            const openSlotModal = (dayIndex, periodIndex) => {
                setEditingSlot({ dayIndex, periodIndex });
                const existing = schedules.find(s => s.classId === selectedClassId && s.dayIndex === dayIndex && s.periodIndex === periodIndex);
                setFormData(existing ? { subjectId: existing.subjectId, teacherId: existing.teacherId } : { subjectId: '', teacherId: '' });
                setErrorMsg('');
                setModalOpen(true);
            };

            // --- RENDER COMPONENTS ---

            const renderDashboard = () => React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-4 gap-6 animate-fade-in" },
                React.createElement("div", { className: "md:col-span-4 bg-white p-8 rounded-2xl shadow-sm border border-slate-200" },
                    React.createElement("h2", { className: "text-2xl font-bold text-slate-800 mb-2" }, "Selamat Datang, Admin Kurikulum"),
                    React.createElement("p", { className: "text-slate-500" }, "Silahkan pilih menu di sebelah kiri untuk mulai mengelola data sekolah.")
                ),
                [
                    { label: 'Guru', val: teachers.length, icon: Users, color: 'bg-blue-500' },
                    { label: 'Rombel', val: classes.length, icon: GraduationCap, color: 'bg-green-500' },
                    { label: 'Mapel', val: subjects.length, icon: BookOpen, color: 'bg-purple-500' },
                    { label: 'Ruang', val: rooms.length, icon: Layout, color: 'bg-orange-500' },
                ].map((stat, idx) => (
                    React.createElement("div", { key: idx, className: "bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center gap-4" },
                        React.createElement("div", { className: `p-4 rounded-lg text-white shadow-md ${stat.color}` }, React.createElement(stat.icon, { size: 24 })),
                        React.createElement("div", null,
                            React.createElement("p", { className: "text-slate-500 text-xs font-bold uppercase" }, stat.label),
                            React.createElement("p", { className: "text-2xl font-bold text-slate-800" }, stat.val)
                        )
                    )
                ))
            );

            const renderGuruTab = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl"><Users size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Manajemen Data Guru</h2>
                                <p className="text-slate-500 text-sm">Kelola informasi lengkap seluruh tenaga pendidik.</p>
                            </div>
                        </div>
                        <button onClick={() => openGuruModal('edit', null)} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-lg active:scale-95 shadow-indigo-100">
                            <Plus size={20} /> Tambah Guru
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-600 font-bold border-b">
                                <tr>
                                    <th className="p-4">No</th>
                                    <th className="p-4">Kode</th>
                                    <th className="p-4">Nama Guru</th>
                                    <th className="p-4">NIP</th>
                                    <th className="p-4">Tugas Tambahan</th>
                                    <th className="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {teachers.map((t, i) => (
                                    <tr key={t.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-4 text-slate-500">{i + 1}</td>
                                        <td className="p-4 font-mono font-bold text-blue-600">{t.code}</td>
                                        <td className="p-4 font-bold text-slate-800">{t.name}<div className="text-xs font-normal text-slate-500">{t.rank}</div></td>
                                        <td className="p-4 text-slate-600 font-mono text-xs">{t.nip || '-'}</td>
                                        <td className="p-4">
                                            {t.tugasTambahanId && <div className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded inline-block mb-1 mr-1 font-bold">{tugasTambahanList.find(x => x.id === t.tugasTambahanId)?.name}</div>}
                                            {t.pembinaId && <div className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded inline-block font-bold">{pembinaList.find(x => x.id === t.pembinaId)?.name}</div>}
                                        </td>
                                        <td className="p-4 text-center flex justify-center gap-2">
                                            <button onClick={() => openGuruModal('view', t)} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><Eye size={18} /></button>
                                            <button onClick={() => openGuruModal('edit', t)} className="p-2 text-amber-600 hover:bg-amber-50 rounded"><Edit2 size={18} /></button>
                                            <button onClick={() => deleteItem(setTeachers, teachers, t.id)} className="p-2 text-red-600 hover:bg-red-50 rounded"><Trash2 size={18} /></button>
                                        </td>
                                    </tr>
                                ))}
                                {teachers.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400">Belum ada data guru.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            // Placeholder for other missing render functions

            const renderRombelTab = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="p-3 bg-emerald-100 text-emerald-600 rounded-xl"><GraduationCap size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Manajemen Rombongan Belajar</h2>
                                <p className="text-slate-500 text-sm">Kelola data kelas, wali kelas, dan ruang belajar.</p>
                            </div>
                        </div>
                        <button onClick={handleTambahRombel} className="px-5 py-3 bg-emerald-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-emerald-700 transition-all shadow-lg active:scale-95 shadow-emerald-100">
                            <Plus size={20} /> Tambah Rombel
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-600 font-bold border-b text-[10px] uppercase tracking-wider">
                                <tr>
                                    <th className="p-4 w-12 text-center">No</th>
                                    <th className="p-4">Nama Rombel</th>
                                    <th className="p-4 hidden md:table-cell">Kurikulum</th>
                                    <th className="p-4 hidden md:table-cell">Wali Kelas</th>
                                    <th className="p-4 w-48 text-center">Menu</th>
                                    <th className="p-4 w-24 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {classes.map((cls, idx) => (
                                    <tr key={cls.id} className={`hover:bg-blue-50/50 transition-colors cursor-pointer ${selectedRombelRow === cls.id ? 'bg-blue-50/80 border-l-4 border-l-blue-600' : ''}`} onClick={() => handleSelectRombelRow(cls)}>
                                        <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800 text-base">{cls.name}</div>
                                            <div className="text-[10px] text-slate-400 font-medium md:hidden">{cls.curriculum}</div>
                                        </td>
                                        <td className="p-4 hidden md:table-cell">
                                            <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px] font-bold border border-blue-100 uppercase">{cls.curriculum}</span>
                                        </td>
                                        <td className="p-4 hidden md:table-cell">
                                            <div className="flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500 border border-slate-200">{teachers.find(t => t.id === cls.teacherId)?.name?.charAt(0) || '?'}</div>
                                                <span className="text-slate-700 text-sm font-medium">{teachers.find(t => t.id === cls.teacherId)?.name || <span className="text-slate-300 italic font-normal">Belum diset</span>}</span>
                                            </div>
                                        </td>
                                        <td className="p-4 text-center" onClick={(e) => e.stopPropagation()}>
                                            <button onClick={() => { handleSelectRombelRow(cls); handleOpenLearning(); }} className="px-3 py-1.5 bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-lg font-bold text-xs flex items-center justify-center gap-2 mx-auto transition-all border border-blue-100"><BookOpen size={14} /> Pembelajaran</button>
                                        </td>
                                        <td className="p-4 text-center" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-center gap-1">
                                                <button onClick={() => { handleSelectRombelRow(cls); setIsEditingRombel(true); }} title="Edit Rombel" className="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition-colors"><Edit2 size={16} /></button>
                                                <button onClick={() => handleDeleteRombel(cls.id)} title="Hapus Rombel" className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={16} /></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {classes.length === 0 && <tr><td colSpan="6" className="p-12 text-center">
                                    <div className="flex flex-col items-center gap-2 text-slate-400">
                                        <Layers size={40} className="opacity-20" />
                                        <p className="font-medium text-slate-500">Belum ada data rombel</p>
                                        <p className="text-xs">Silahkan tambahkan rombel baru melalui tombol di atas.</p>
                                    </div>
                                </td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* MODAL INPUT/EDIT ROMBEL */}
                    {isEditingRombel && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-in border border-slate-200">
                                <div className="bg-slate-900 p-5 text-white flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-blue-600 rounded-lg"><GraduationCap size={20} /></div>
                                        <div>
                                            <h3 className="font-bold text-lg leading-tight">{selectedRombelRow && classes.find(c => c.id === selectedRombelRow) ? 'Edit Data Rombel' : 'Tambah Rombel Baru'}</h3>
                                            <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Informasi Rombongan Belajar</p>
                                        </div>
                                    </div>
                                    <button onClick={resetRombelForm} className="hover:bg-slate-800 p-2 rounded-full transition-colors"><X size={20} /></button>
                                </div>

                                <div className="p-6 space-y-5 bg-white">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nama Rombel</label>
                                            <div className="relative">
                                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Tag size={16} /></div>
                                                <select className="w-full border-slate-200 border bg-slate-50 p-2.5 pl-10 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none" value={rombelForm.name} onChange={e => setRombelForm({ ...rombelForm, name: e.target.value })}>
                                                    <option value="">- Pilih Nama Rombel -</option>
                                                    {masterRombelNames.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                                </select>
                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><ChevronDown size={16} /></div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Tingkat Kelas</label>
                                                <select className="w-full border-slate-200 border bg-white p-2.5 rounded-xl text-sm font-medium text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={rombelForm.level} onChange={e => setRombelForm({ ...rombelForm, level: e.target.value })}>
                                                    <option value="7">Kelas 7</option>
                                                    <option value="8">Kelas 8</option>
                                                    <option value="9">Kelas 9</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Kurikulum</label>
                                                <select className="w-full border-slate-200 border bg-white p-2.5 rounded-xl text-sm font-medium text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={rombelForm.curriculum} onChange={e => setRombelForm({ ...rombelForm, curriculum: e.target.value })}>
                                                    <option value="">- Pilih -</option>
                                                    {curriculums.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Wali Kelas</label>
                                            <div className="relative">
                                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Users size={16} /></div>
                                                <select className="w-full border-slate-200 border bg-white p-2.5 pl-10 rounded-xl text-sm font-medium text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none" value={rombelForm.teacherId} onChange={e => setRombelForm({ ...rombelForm, teacherId: e.target.value })}>
                                                    <option value="">- Pilih Wali Kelas -</option>
                                                    {teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                </select>
                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><ChevronDown size={16} /></div>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Ruang Kelas</label>
                                            <div className="relative">
                                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Layout size={16} /></div>
                                                <select className="w-full border-slate-200 border bg-white p-2.5 pl-10 rounded-xl text-sm font-medium text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none" value={rombelForm.roomId} onChange={e => setRombelForm({ ...rombelForm, roomId: e.target.value })}>
                                                    <option value="">- Pilih Ruang -</option>
                                                    {rooms.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                                </select>
                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><ChevronDown size={16} /></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-3 pt-6 border-t border-slate-100 mt-2">
                                        <button onClick={resetRombelForm} className="flex-1 px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-bold text-sm transition-all focus:ring-2 focus:ring-slate-300">Batal</button>
                                        <button onClick={handleSaveRombel} className="flex-[2] bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-sm flex justify-center items-center gap-2 shadow-lg shadow-blue-200 transition-all active:scale-[0.98]"><Save size={18} /> Simpan Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
            const renderScheduler = () => {
                const handleSlotClick = (dayIndex, periodIndex) => {
                    if (!selectedClassId) {
                        showToast("Harap pilih Rombel terlebih dahulu.", "info");
                        return;
                    }
                    openSlotModal(dayIndex, periodIndex);
                };

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-rose-100 text-rose-600 rounded-xl"><Calendar size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Jadwal Pelajaran Rombel</h2>
                                    <p className="text-slate-500">Atur jadwal mingguan untuk setiap rombongan belajar.</p>
                                </div>
                            </div>
                            <div className="min-w-[250px]">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Pilih Rombel / Kelas</label>
                                <select
                                    className="w-full border-slate-200 border bg-white p-3 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-rose-500 outline-none transition-all"
                                    value={selectedClassId}
                                    onChange={(e) => setSelectedClassId(e.target.value)}
                                >
                                    <option value="">-- Pilih Rombongan Belajar --</option>
                                    {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                        </div>

                        {selectedClassId ? (
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs border-collapse">
                                        <thead>
                                            <tr className="bg-slate-50 border-b">
                                                <th className="p-4 border-r w-32 bg-slate-100 font-bold text-slate-600">JAM / WAKTU</th>
                                                {DEFAULT_DAYS.map(day => <th key={day} className="p-4 font-bold text-slate-700 min-w-[150px] uppercase tracking-widest">{day}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {periodTimes.map((period, pIdx) => (
                                                <tr key={pIdx} className="border-b hover:bg-slate-50/30 transition-colors">
                                                    <td className="p-3 border-r bg-slate-50 text-center font-bold">
                                                        <div className="text-slate-400 text-[10px] uppercase font-black italic">Ke-{pIdx + 1}</div>
                                                        <div className="text-slate-700 font-mono mt-1">{period.time}</div>
                                                    </td>
                                                    {DEFAULT_DAYS.map((day, dIdx) => {
                                                        const slot = schedules.find(s => s.classId === selectedClassId && s.dayIndex === dIdx && s.periodIndex === pIdx);
                                                        const subject = subjects.find(s => s.id === slot?.subjectId);
                                                        const teacher = teachers.find(t => t.id === slot?.teacherId);

                                                        return (
                                                            <td
                                                                key={dIdx}
                                                                onClick={() => handleSlotClick(dIdx, pIdx)}
                                                                className="p-1 cursor-pointer group"
                                                            >
                                                                <div className={`h-16 rounded-xl border-2 border-dashed flex flex-col items-center justify-center p-2 transition-all ${slot ? 'border-blue-200 bg-blue-50/50 hover:bg-blue-100 shadow-sm' : 'border-slate-100 hover:border-rose-200 hover:bg-rose-50/30'}`}>
                                                                    {slot ? (
                                                                        <>
                                                                            <div className="font-black text-blue-700 text-center text-[9px] uppercase leading-tight line-clamp-2">{subject?.name}</div>
                                                                            <div className="text-[9px] text-blue-500 font-bold mt-1 border-t border-blue-100 pt-0.5 w-full text-center flex items-center justify-center gap-1"><Users size={8} /> {teacher?.code}</div>
                                                                        </>
                                                                    ) : (
                                                                        <Plus size={16} className="text-slate-200 group-hover:text-rose-300 transition-colors" />
                                                                    )}
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-slate-100/50 border-2 border-dashed border-slate-200 rounded-2xl py-20 flex flex-col items-center justify-center text-center">
                                <Calendar size={64} className="text-slate-300 mb-4" />
                                <h3 className="text-xl font-bold text-slate-400 uppercase tracking-tighter">PILIH ROMBEL TERLEBIH DAHULU</h3>
                                <p className="text-slate-400 text-sm mt-1 max-w-sm">Jadwal pelajaran diatur per rombongan belajar (kelas).</p>
                            </div>
                        )}
                    </div>
                );
            };
            const renderSettingsTab = () => {
                const handleSaveSettings = (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const newProfile = {
                        name: fd.get('schoolName'),
                        address: fd.get('schoolAddress'),
                        academicYear: fd.get('academicYear'),
                        appName: fd.get('appName'),
                        headerTitle: `JADWAL PELAJARAN TAHUN AJARAN ${fd.get('academicYear')}`
                    };
                    setSchoolProfile(newProfile);
                    localStorage.setItem('smp_school_profile', JSON.stringify(newProfile));

                    const newCredentials = {
                        username: fd.get('username') || 'admin',
                        password: fd.get('password') || '123'
                    };
                    setAdminCredentials(newCredentials);
                    localStorage.setItem('smp_admin_credentials', JSON.stringify(newCredentials));

                    showToast("Pengaturan aplikasi dan akses berhasil disimpan!", "success");
                };

                return (
                    <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                            <div className="flex items-center gap-4 mb-8 pb-6 border-b border-slate-100">
                                <div className="p-4 bg-slate-100 text-slate-600 rounded-2xl"><Settings size={32} /></div>
                                <div>
                                    <h2 className="text-3xl font-black text-slate-800 tracking-tight">Pengaturan Aplikasi</h2>
                                    <p className="text-slate-500 font-medium">Konfigurasi identitas sekolah dan parameter sistem.</p>
                                </div>
                            </div>

                            <form onSubmit={handleSaveSettings} className="space-y-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Grid size={14} /> Nama Aplikasi</label>
                                        <input name="appName" defaultValue={schoolProfile.appName} className="w-full border-slate-200 border bg-slate-50 p-4 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all focus:bg-white" />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Calendar size={14} /> Tahun Ajaran</label>
                                        <input name="academicYear" defaultValue={schoolProfile.academicYear} placeholder="Contoh: 2026/2027" className="w-full border-slate-200 border bg-slate-50 p-4 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all focus:bg-white" />
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Briefcase size={14} /> Nama Instansi / Sekolah</label>
                                    <input name="schoolName" defaultValue={schoolProfile.name} className="w-full border-slate-200 border bg-slate-50 p-4 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all focus:bg-white" />
                                </div>
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Layout size={14} /> Alamat Sekolah / Footer Laporan</label>
                                    <textarea name="schoolAddress" defaultValue={schoolProfile.address} className="w-full border-slate-200 border bg-slate-50 p-4 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all focus:bg-white h-24" />
                                </div>

                                <div className="pt-8 mt-4 border-t border-slate-100">
                                    <h3 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-3">
                                        <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg"><ShieldCheck size={20} /></div>
                                        Akses Akun Administrator
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="space-y-2">
                                            <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Users size={14} /> Username / NIP Admin</label>
                                            <input name="username" defaultValue={adminCredentials.username} className="w-full border-slate-200 border bg-slate-50 p-4 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition-all focus:bg-white" />
                                        </div>
                                        <div className="space-y-2">
                                            <label className="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-widest ml-1"><Lock size={14} /> Password Sistem</label>
                                            <div className="relative group">
                                                <input
                                                    type={showSettingsPassword ? "text" : "password"}
                                                    name="password"
                                                    defaultValue={adminCredentials.password}
                                                    className="w-full border-slate-200 border bg-slate-50 p-4 pr-12 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition-all focus:bg-white"
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowSettingsPassword(!showSettingsPassword)}
                                                    className="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-indigo-600 transition-colors focus:outline-none"
                                                >
                                                    {showSettingsPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-6 border-t border-slate-100 flex justify-end">
                                    <button type="submit" className="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-sm uppercase tracking-widest flex items-center gap-3 hover:bg-slate-800 shadow-2xl active:scale-95 transition-all">
                                        <Save size={20} /> Simpan Semua Perubahan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            const renderMasterRombelNames = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-pink-100 text-pink-600 rounded-xl"><Tag size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Nama Rombongan Belajar</h2>
                                    <p className="text-slate-500 text-sm">Kelola daftar pilihan nama kelas (misal: VII-A, VIII-A, dsb).</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('rombel')} className="px-5 py-3 bg-pink-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-pink-700 transition-all shadow-lg active:scale-95 shadow-pink-100">
                                <Plus size={20} /> Tambah Data
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Rombel</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {masterRombelNames.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700 uppercase tracking-tight">{item.name}</td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('rombel', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setMasterRombelNames, masterRombelNames, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterMapel = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-blue-100 text-blue-600 rounded-xl"><BookOpen size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Mata Pelajaran</h2>
                                    <p className="text-slate-500 text-sm">Kelola daftar kurikulum mata pelajaran sekolah.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('mapel')} className="px-5 py-3 bg-blue-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700 transition-all shadow-lg active:scale-95 shadow-blue-100">
                                <Plus size={20} /> Tambah Mapel
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Mapel</th>
                                        <th className="p-4">Kode</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {subjects.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700">{item.name}</td>
                                            <td className="p-4"><span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px] font-bold border border-blue-100 uppercase">{item.code}</span></td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('mapel', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setSubjects, subjects, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterRuang = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-orange-100 text-orange-600 rounded-xl"><Layout size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Ruang Kelas</h2>
                                    <p className="text-slate-500 text-sm">Kelola aset ruangan yang tersedia untuk KBM.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('ruang')} className="px-5 py-3 bg-orange-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-orange-700 transition-all shadow-lg active:scale-95 shadow-orange-100">
                                <Plus size={20} /> Tambah Ruang
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Ruang</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {rooms.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700 uppercase tracking-tight">{item.name}</td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('ruang', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setRooms, rooms, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterKurikulum = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-teal-100 text-teal-600 rounded-xl"><Layers size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Kurikulum</h2>
                                    <p className="text-slate-500 text-sm">Kelola standar kurikulum yang digunakan di sekolah.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('kurikulum')} className="px-5 py-3 bg-teal-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-teal-700 transition-all shadow-lg active:scale-95 shadow-teal-100">
                                <Plus size={20} /> Tambah Kurikulum
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Kurikulum</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {curriculums.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700 uppercase tracking-tight ">{item.name}</td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('kurikulum', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setCurriculums, curriculums, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterJam = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-4 mb-8">
                            <div className="p-3 bg-red-100 text-red-600 rounded-xl"><Clock size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Master Jam Pelajaran</h2>
                                <p className="text-slate-500">Atur rentang waktu untuk setiap jam pelajaran (JP).</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">JP</th>
                                        <th className="p-4">Rentang Waktu (Contoh: 07.40 - 08.20)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {periodTimes.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50 transition-colors">
                                            <td className="p-4 text-center bg-slate-50/80 font-black text-slate-600">{idx + 1}</td>
                                            <td className="p-2 px-4">
                                                <input
                                                    type="text"
                                                    value={item.time}
                                                    onChange={(e) => {
                                                        const newTimes = [...periodTimes];
                                                        newTimes[idx].time = e.target.value;
                                                        setPeriodTimes(newTimes);
                                                    }}
                                                    className="w-full p-2 bg-transparent border-b-2 border-transparent focus:border-red-400 outline-none font-mono text-sm tracking-widest text-slate-700 font-bold transition-all"
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-6 p-4 bg-red-50 rounded-xl flex items-start gap-3 border border-red-100">
                            <Info size={18} className="text-red-500 mt-0.5" />
                            <p className="text-xs text-red-700 leading-relaxed font-medium">Perubahan pada jam pelajaran ini akan langsung diterapkan secara otomatis di seluruh jadwal kelas dan tampilan dashboard.</p>
                        </div>
                    </div>
                </div>
            );

            const renderMasterMaxJam = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-4 mb-8">
                            <div className="p-3 bg-yellow-100 text-yellow-600 rounded-xl"><AlertTriangle size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Master Maximal Jam Pelajaran</h2>
                                <p className="text-slate-500">Tentukan batas maksimal JP per minggu untuk setiap mata pelajaran.</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4">Nama Mata Pelajaran</th>
                                        <th className="p-4">Kode</th>
                                        <th className="p-4 w-48 text-center">Batas Maks JP / Minggu</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {subjects.map((item) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 font-bold text-slate-700">{item.name}</td>
                                            <td className="p-4"><span className="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[10px] font-bold border border-slate-200 uppercase">{item.code}</span></td>
                                            <td className="p-2 px-4">
                                                <div className="flex items-center gap-3">
                                                    <input
                                                        type="number"
                                                        value={maxHourSettings[item.id] || ''}
                                                        placeholder="0"
                                                        onChange={(e) => handleUpdateMaxHour(item.id, e.target.value)}
                                                        className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-center font-black text-slate-800 focus:ring-2 focus:ring-yellow-400 outline-none transition-all"
                                                    />
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">JP</span>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-6 p-4 bg-yellow-50 rounded-xl flex items-start gap-3 border border-yellow-100">
                            <AlertCircle size={18} className="text-yellow-600 mt-0.5" />
                            <p className="text-xs text-yellow-800 leading-relaxed font-medium">Batas JP ini akan menjadi validasi sistem saat Anda mengatur "Pembagian Tugas Mengajar". Anda tidak bisa menginput JP melebihi angka yang ditetapkan di sini.</p>
                        </div>
                    </div>
                </div>
            );

            const renderMasterSK = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-4 mb-8">
                            <div className="p-3 bg-purple-100 text-purple-600 rounded-xl"><FileSignature size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Master SK & Tanggal Pelajaran</h2>
                                <p className="text-slate-500">Atur nomor SK Pembagian Tugas dan tanggal penetapan default.</p>
                            </div>
                        </div>

                        <div className="bg-slate-50 p-8 rounded-2xl border border-slate-100 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Nomor SK Pembagian Tugas (Default)</label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><FileText size={20} /></div>
                                    <input
                                        type="text"
                                        placeholder="Contoh: 421/001/SMPN2/VII/2026"
                                        className="w-full border-slate-200 border bg-white p-4 pl-12 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                        value={masterSK.number}
                                        onChange={(e) => setMasterSK({ ...masterSK, number: e.target.value })}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Tanggal Penetapan / SK</label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Calendar size={20} /></div>
                                    <input
                                        type="date"
                                        className="w-full border-slate-200 border bg-white p-4 pl-12 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                        value={masterSK.date}
                                        onChange={(e) => setMasterSK({ ...masterSK, date: e.target.value })}
                                    />
                                </div>
                            </div>
                            <div className="p-4 bg-purple-100/50 rounded-xl border border-purple-100 text-[11px] text-purple-800 italic font-medium leading-relaxed">
                                Nomor SK dan Tanggal di atas akan digunakan sebagai nilai default (otomatis terisi) saat Anda menginput data di menu <b>Pembagian Tugas Mengajar</b> untuk setiap rombel.
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderMasterTugas = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-cyan-100 text-cyan-600 rounded-xl"><Briefcase size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Tugas Tambahan</h2>
                                    <p className="text-slate-500 text-sm">Kelola daftar jabatan tugas tambahan dan beban JP-nya.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('tugas')} className="px-5 py-3 bg-cyan-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-cyan-700 transition-all shadow-lg active:scale-95 shadow-cyan-100">
                                <Plus size={20} /> Tambah Tugas
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Jabatan</th>
                                        <th className="p-4 text-center">Beban JP / Minggu</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {tugasTambahanList.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700">{item.name}</td>
                                            <td className="p-4 text-center"><span className="px-4 py-1.5 bg-cyan-50 text-cyan-700 rounded-full text-sm font-black border border-cyan-100">{item.hours} JP</span></td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('tugas', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setTugasTambahanList, tugasTambahanList, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterPembina = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-lime-100 text-lime-600 rounded-xl"><Award size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Pembina Ekstrakurikuler</h2>
                                    <p className="text-slate-500 text-sm">Kelola daftar pembina kegiatan tambahan siswa.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('pembina')} className="px-5 py-3 bg-lime-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-lime-700 transition-all shadow-lg active:scale-95 shadow-lime-100">
                                <Plus size={20} /> Tambah Pembina
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Kegiatan</th>
                                        <th className="p-4 text-center">Beban JP / Minggu</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {pembinaList.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700">{item.name}</td>
                                            <td className="p-4 text-center"><span className="px-4 py-1.5 bg-lime-50 text-lime-700 rounded-full text-sm font-black border border-lime-100">{item.hours} JP</span></td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('pembina', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setPembinaList, pembinaList, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
            const renderMasterPangkatGolongan = () => (
                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-emerald-100 text-emerald-600 rounded-xl"><ShieldCheck size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Master Pangkat / Golongan</h2>
                                    <p className="text-slate-500 text-sm">Kelola daftar pilihan pangkat dan golongan untuk data guru.</p>
                                </div>
                            </div>
                            <button onClick={() => handleAddNewMaster('pangkat')} className="px-5 py-3 bg-emerald-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-emerald-700 transition-all shadow-lg active:scale-95 shadow-emerald-100">
                                <Plus size={20} /> Tambah Data
                            </button>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-bold border-b text-[10px] uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Nama Pangkat / Golongan</th>
                                        <th className="p-4 w-24 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {pangkatGolonganList.map((item, idx) => (
                                        <tr key={item.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                            <td className="p-4 font-bold text-slate-700 uppercase tracking-tight">{item.name}</td>
                                            <td className="p-4 flex justify-center gap-1">
                                                <button onClick={() => startEditMaster('pangkat', item)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={16} /></button>
                                                <button onClick={() => deleteItem(setPangkatGolonganList, pangkatGolonganList, item.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {pangkatGolonganList.length === 0 && (
                                        <tr><td colSpan="3" className="p-8 text-center text-slate-400">Belum ada data pangkat/golongan.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderMasterPicket = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-4 mb-6">
                            <div className="p-3 bg-amber-100 text-amber-600 rounded-xl"><Settings size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Pengaturan Master Piket</h2>
                                <p className="text-slate-500">Atur parameter global untuk tugas guru piket.</p>
                            </div>
                        </div>

                        <div className="max-w-md bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2"><Clock size={18} className="text-amber-500" /> Beban Jam Mengajar (JP) per Piket</label>
                            <div className="flex items-center gap-4">
                                <input
                                    type="number"
                                    min="0"
                                    className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none font-bold text-lg text-slate-700"
                                    value={picketLoad}
                                    onChange={(e) => {
                                        const val = parseInt(e.target.value) || 0;
                                        setPicketLoad(val);
                                        showToast(`Master JP Piket diperbarui ke: ${val} JP`);
                                    }}
                                />
                                <div className="text-slate-500 font-bold uppercase tracking-widest text-xs">JP / MINGGU</div>
                            </div>
                            <p className="mt-4 text-xs text-slate-400 italic leading-relaxed">Jam ini akan otomatis ditambahkan ke total beban mengajar guru di laporan rekapan tugas.</p>
                        </div>
                    </div>
                </div>
            );

            const renderLearningTab = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-4 mb-6">
                            <div className="p-3 bg-blue-100 text-blue-600 rounded-xl"><BookOpen size={32} /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Pembagian Tugas Mengajar</h2>
                                <p className="text-slate-500">Kelola alokasi guru mata pelajaran untuk setiap rombongan belajar.</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {classes.map(cls => (
                                <button key={cls.id} onClick={() => { setActiveLearningClass(cls.id); setLearningModalOpen(true); }} className="p-5 bg-slate-50 hover:bg-white border border-slate-200 hover:border-blue-500 hover:shadow-lg hover:shadow-blue-100 rounded-2xl transition-all group text-left relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-2 bg-blue-500 text-white transform translate-x-8 -translate-y-8 group-hover:translate-x-0 group-hover:translate-y-0 transition-transform rounded-bl-xl"><Plus size={16} /></div>
                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Kelas {cls.level}</div>
                                    <div className="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition-colors uppercase tracking-tight">{cls.name}</div>
                                    <div className="mt-4 flex items-center justify-between">
                                        <div className="text-[10px] font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded-lg">LIHAT ALOKASI</div>
                                        <div className="text-[10px] font-medium text-slate-400 italic font-sans">{allocations.filter(a => a.classId === cls.id && a.teacherId).length} Mapel Terisi</div>
                                    </div>
                                </button>
                            ))}
                        </div>

                        {classes.length === 0 && (
                            <div className="py-20 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                                <div className="mx-auto w-20 h-20 bg-white rounded-full flex items-center justify-center text-slate-300 shadow-sm mb-4"><GraduationCap size={40} /></div>
                                <h3 className="text-lg font-bold text-slate-700">Belum Ada Data Rombel</h3>
                                <p className="text-slate-500 text-sm max-w-xs mx-auto mt-2">Anda perlu menambahkan data Rombongan Belajar terlebih dahulu untuk mengatur pembelajaran.</p>
                                <button onClick={() => setActiveTab('rombel')} className="mt-6 px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">Buka Menu Rombel</button>
                            </div>
                        )}
                    </div>
                </div>
            );
            const renderPicketTab = () => {
                const teachersNoPicket = teachers.filter(t => !picketSchedule[t.id]);

                return (
                    <div className="space-y-6 animate-fade-in">
                        {/* Header Section */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl"><Coffee size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Jadwal Guru Piket</h2>
                                    <p className="text-slate-500">Kelola distribusi petugas piket harian sekolah.</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-xl border border-slate-200">
                                <Info size={18} className="text-indigo-500" />
                                <span className="text-xs font-bold text-slate-600 uppercase">Input Otomatis Tersimpan</span>
                            </div>
                        </div>

                        {/* Database Diagnostic Section */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mt-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-amber-100 text-amber-600 rounded-lg"><Database size={20} /></div>
                                    <div>
                                        <h3 className="font-bold text-slate-800">Status Koneksi Database Cloud</h3>
                                        <p className="text-xs text-slate-500 font-medium">Pastikan aplikasi terhubung ke Supabase dengan benar.</p>
                                    </div>
                                </div>
                                <button
                                    onClick={testConnection}
                                    className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold transition-all shadow-lg shadow-amber-100 flex items-center gap-2 active:scale-95"
                                >
                                    <RefreshCw size={14} className={isSyncing ? 'animate-spin' : ''} />
                                    Tes Koneksi Sekarang
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Input Table - 3 Columns wide */}
                            <div className="md:col-span-2">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-4 bg-slate-50 border-b flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <Edit2 size={16} className="text-slate-400" />
                                            <h3 className="font-bold text-slate-700 text-sm">Form Pengaturan Piket</h3>
                                        </div>
                                        <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total: {teachers.length} Guru</div>
                                    </div>
                                    <div className="max-h-[500px] overflow-y-auto custom-scrollbar">
                                        <table className="w-full text-sm text-left border-collapse">
                                            <thead className="bg-slate-50 text-slate-600 font-bold border-b text-[10px] uppercase tracking-wider sticky top-0 z-10">
                                                <tr>
                                                    <th className="p-4 w-12 text-center">No</th>
                                                    <th className="p-4">Nama Guru / Kode</th>
                                                    <th className="p-4 w-64 text-center">Pilih Hari Piket</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {teachers.map((t, i) => {
                                                    const currentDay = picketSchedule[t.id] || "";
                                                    return (
                                                        <tr key={t.id} className="hover:bg-slate-50/50 transition-colors">
                                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{i + 1}</td>
                                                            <td className="p-4">
                                                                <div className="font-bold text-slate-800">{t.name}</div>
                                                                <div className="inline-block mt-1 px-1.5 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] font-mono font-bold rounded border border-indigo-100 uppercase tracking-tighter">KODE: {t.code}</div>
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                <div className="relative inline-block w-full max-w-[200px]">
                                                                    <select
                                                                        className={`w-full p-2.5 rounded-xl border text-xs font-bold transition-all outline-none appearance-none cursor-pointer ${currentDay ? 'bg-indigo-600 border-indigo-600 text-white shadow-md shadow-indigo-100' : 'bg-slate-50 border-slate-200 text-slate-500 hover:border-indigo-300'}`}
                                                                        value={currentDay}
                                                                        onChange={(e) => {
                                                                            handlePicketChange(t.id, e.target.value);
                                                                            if (e.target.value) showToast(`${t.name} diatur piket hari ${e.target.value}`);
                                                                        }}
                                                                    >
                                                                        <option value="" className="text-slate-800 bg-white">- No Piket -</option>
                                                                        {PIKET_DAYS.map(day => <option key={day} value={day} className="text-slate-800 bg-white">{day}</option>)}
                                                                    </select>
                                                                    <div className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${currentDay ? 'text-indigo-200' : 'text-slate-400'}`}>
                                                                        <ChevronDown size={14} />
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            {/* Status Section - 1 Column wide */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
                                    <div className="p-4 bg-red-50 border-b border-red-100 flex items-center gap-2">
                                        <AlertCircle size={16} className="text-red-500" />
                                        <h3 className="font-bold text-red-700 text-sm">Belum Piket ({teachersNoPicket.length})</h3>
                                    </div>
                                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50">
                                        {teachersNoPicket.length > 0 ? (
                                            <div className="space-y-2">
                                                {teachersNoPicket.map(t => (
                                                    <div key={t.id} className="p-3 bg-white border border-slate-200 rounded-xl shadow-sm flex items-center gap-3 group hover:border-red-200 transition-all">
                                                        <div className="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center font-bold text-xs shrink-0">{t.code}</div>
                                                        <span className="text-xs font-semibold text-slate-700 truncate">{t.name}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center py-12 text-center">
                                                <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-4"><CheckCircle size={32} /></div>
                                                <h4 className="text-sm font-bold text-slate-700">Lengkap!</h4>
                                                <p className="text-[10px] text-slate-500 mt-1 uppercase tracking-wider font-medium">Semua guru sudah dijadwalkan</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Landscape Grouped by Day Bar - BOTTOM Section */}
                        <div className="space-y-4">
                            <div className="flex items-center gap-2 px-2">
                                <Users size={20} className="text-indigo-500" />
                                <h3 className="font-bold text-slate-800 tracking-tight">Grup Piket Harian (Landscape View)</h3>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                                {PIKET_DAYS.map(day => {
                                    const dayTeachers = teachers.filter(t => picketSchedule[t.id] === day);

                                    // Color Mapping for Days
                                    const dayColorMap = {
                                        'Senin': { bg: 'bg-blue-50', border: 'border-blue-100', text: 'text-blue-600', accent: 'bg-blue-600', light: 'bg-blue-50/50' },
                                        'Selasa': { bg: 'bg-rose-50', border: 'border-rose-100', text: 'text-rose-600', accent: 'bg-rose-600', light: 'bg-rose-50/50' },
                                        'Rabu': { bg: 'bg-orange-50', border: 'border-orange-100', text: 'text-orange-600', accent: 'bg-orange-600', light: 'bg-orange-50/50' },
                                        'Kamis': { bg: 'bg-indigo-50', border: 'border-indigo-100', text: 'text-indigo-600', accent: 'bg-indigo-600', light: 'bg-indigo-50/50' },
                                        'Jumat': { bg: 'bg-emerald-50', border: 'border-emerald-100', text: 'text-emerald-600', accent: 'bg-emerald-600', light: 'bg-emerald-50/50' },
                                        'Sabtu': { bg: 'bg-amber-50', border: 'border-amber-100', text: 'text-amber-600', accent: 'bg-amber-600', light: 'bg-amber-50/50' }
                                    };

                                    const theme = dayColorMap[day] || { bg: 'bg-slate-50', border: 'border-slate-100', text: 'text-slate-600', accent: 'bg-slate-600', light: 'bg-slate-50' };

                                    return (
                                        <div key={day} className={`bg-white rounded-2xl border ${theme.border} shadow-sm overflow-hidden hover:shadow-md transition-all group border-b-4`}>
                                            <div className={`p-3 ${theme.bg} border-b ${theme.border} flex justify-between items-center transition-colors`}>
                                                <span className={`text-[10px] font-black ${theme.text} uppercase tracking-tight`}>{day}</span>
                                                <span className={`px-2 py-0.5 bg-white border ${theme.border} rounded-full text-[10px] font-black ${theme.text} shadow-sm`}>{dayTeachers.length}</span>
                                            </div>
                                            <div className="p-3 space-y-2 min-h-[120px] max-h-[160px] overflow-y-auto custom-scrollbar bg-white">
                                                {dayTeachers.length > 0 ? dayTeachers.map(t => (
                                                    <div key={t.id} className={`flex flex-col p-2 bg-slate-50 border border-slate-100 rounded-lg hover:${theme.border} hover:${theme.light} transition-all`}>
                                                        <div className="text-[10px] font-bold text-slate-800 leading-tight">{t.name}</div>
                                                        <div className={`text-[9px] font-mono font-black ${theme.text} mt-0.5`}>{t.code}</div>
                                                    </div>
                                                )) : (
                                                    <div className="h-full flex flex-col items-center justify-center opacity-30 py-8">
                                                        <Coffee size={24} className="text-slate-300 mb-1" />
                                                        <span className="text-[9px] font-bold text-slate-400 uppercase">Kosong</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };


            const renderRecapTab = () => {
                // Calculate Data for Each Teacher
                const recapData = teachers.map(t => {
                    // 1. Teaching Hours
                    const teacherAllocations = allocations.filter(a => a.teacherId === t.id);
                    let teachingJP = 0;
                    const details = teacherAllocations.map(a => {
                        const subj = subjects.find(s => s.id === a.subjectId);
                        const cls = classes.find(c => c.id === a.classId);
                        const horas = parseInt(a.hours || (subj ? subj.jp : 0) || 0);
                        teachingJP += horas;
                        return {
                            subjName: subj ? subj.name : 'Unknown',
                            className: cls ? cls.name : 'Unknown',
                            jp: horas
                        };
                    });

                    // 2. Additional Task Hours
                    const tt = tugasTambahanList.find(item => item.id === t.tugasTambahanId);
                    const ttHours = tt ? parseInt(tt.hours || 0) : 0;

                    // 3. Picket Hours
                    const picketDay = picketSchedule[t.id];
                    const pJP = picketDay ? parseInt(picketLoad || 0) : 0;

                    // 4. Pembina Hours
                    const pb = pembinaList.find(item => item.id === t.pembinaId);
                    const pbHours = pb ? parseInt(pb.hours || 0) : 0;

                    const totalJP = teachingJP + ttHours + pJP + pbHours;

                    return {
                        ...t,
                        teachingJP,
                        details,
                        ttName: tt ? tt.name : '',
                        ttHours,
                        picketDay,
                        pJP,
                        pbName: pb ? pb.name : '',
                        pbHours,
                        totalJP
                    };
                }).sort((a, b) => b.totalJP - a.totalJP);

                const totalSchoolJP = recapData.reduce((acc, curr) => acc + curr.totalJP, 0);
                const avgJP = teachers.length > 0 ? (totalSchoolJP / teachers.length).toFixed(1) : 0;

                return (
                    <div className="space-y-6 animate-fade-in">
                        {/* Header & Print Button */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4 no-print">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-violet-100 text-violet-600 rounded-xl"><ClipboardList size={32} /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Rekapan Pembagian Tugas</h2>
                                    <p className="text-slate-500">Ringkasan total beban mengajar dan tugas tambahan seluruh guru.</p>
                                </div>
                            </div>
                            <button onClick={() => window.print()} className="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-slate-700 transition-all shadow-lg active:scale-95">
                                <Printer size={20} /> Cetak Laporan
                            </button>
                        </div>

                        {/* Summary Stats Cards */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 no-print">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total JP Sekolah</p>
                                <div className="flex items-end gap-2">
                                    <span className="text-3xl font-black text-slate-800">{totalSchoolJP}</span>
                                    <span className="text-sm font-bold text-slate-400 mb-1">JP / Minggu</span>
                                </div>
                                <div className="mt-4 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div className="h-full bg-violet-500 rounded-full" style={{ width: '100%' }}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Rata-rata Beban</p>
                                <div className="flex items-end gap-2">
                                    <span className="text-3xl font-black text-violet-600">{avgJP}</span>
                                    <span className="text-sm font-bold text-slate-400 mb-1">JP / Guru</span>
                                </div>
                                <div className="mt-4 flex items-center gap-1 text-[10px] font-bold text-slate-400 uppercase">
                                    <Target size={12} /> Target Ideal: 24-40 JP
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Guru Mengajar</p>
                                <div className="flex items-end gap-2">
                                    <span className="text-3xl font-black text-emerald-600">{recapData.filter(d => d.teachingJP > 0).length}</span>
                                    <span className="text-sm font-bold text-slate-400 mb-1">Orang</span>
                                </div>
                                <div className="mt-4 flex items-center gap-1 text-[10px] font-bold text-emerald-500 uppercase">
                                    <CheckCircle size={12} /> Aktif di kelas
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Guru</p>
                                <div className="flex items-end gap-2">
                                    <span className="text-3xl font-black text-blue-600">{teachers.length}</span>
                                    <span className="text-sm font-bold text-slate-400 mb-1">Personel</span>
                                </div>
                                <div className="mt-4 flex items-center gap-1 text-[10px] font-bold text-blue-500 uppercase">
                                    <Users size={12} /> Terdaftar di sistem
                                </div>
                            </div>
                        </div>

                        {/* Print Header Section (Only visible in Print) */}
                        <div className="hidden print:block mb-8">
                            <div className="text-center border-b-4 border-double border-slate-800 pb-4 mb-6">
                                <h1 className="text-2xl font-black uppercase text-slate-900">{schoolProfile.name}</h1>
                                <p className="text-sm font-bold text-slate-600">{schoolProfile.headerTitle}</p>
                                <p className="text-xs font-semibold text-slate-500 italic mt-1">{schoolProfile.address}</p>
                            </div>
                            <div className="flex justify-between items-end mb-4">
                                <div>
                                    <h2 className="text-lg font-bold text-slate-800">LAPORAN REKAPAN PEMBAGIAN TUGAS</h2>
                                    <p className="text-[10px] text-slate-500 uppercase tracking-widest font-black">Semester Ganjil {masterSK.semester || '2026/2027'}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Tanggal Cetak: {new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                </div>
                            </div>
                        </div>

                        {/* Detailed Table */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden print:border-none print:shadow-none">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center no-print bg-slate-50/50">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><BarChart3 size={18} className="text-violet-500" /> Tabel Rincian Beban Kerja</h3>
                                <div className="flex items-center gap-4 text-xs">
                                    <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> <span className="text-slate-500 font-medium">Sesuai (24+ JP)</span></div>
                                    <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-amber-500"></div> <span className="text-slate-500 font-medium">Dibawah Minimal</span></div>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead className="bg-slate-50 text-slate-600 font-bold border-b text-[10px] uppercase tracking-wider">
                                        <tr>
                                            <th className="p-4 w-12 text-center">No</th>
                                            <th className="p-4">Nama Guru / NIP</th>
                                            <th className="p-4">Rincian Tugas Mengajar</th>
                                            <th className="p-4 text-center">JP Mengajar</th>
                                            <th className="p-4">Tugas Tambahan / Piket</th>
                                            <th className="p-4 text-center">Total JP</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {recapData.map((d, i) => (
                                            <tr key={d.id} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="p-4 text-center text-slate-400 font-mono text-xs">{i + 1}</td>
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-800 group-hover:text-violet-600 transition-colors uppercase tracking-tight">{d.name}</div>
                                                    <div className="text-[10px] text-slate-400 font-mono mt-0.5">NIP: {d.nip || '-'}</div>
                                                    <div className="mt-1 inline-flex items-center gap-1 px-1.5 py-0.5 bg-slate-100 text-slate-500 text-[9px] font-bold rounded-md">CODE: {d.code}</div>
                                                </td>
                                                <td className="p-4">
                                                    {d.details.length > 0 ? (
                                                        <div className="space-y-1">
                                                            {d.details.map((dt, idx) => (
                                                                <div key={idx} className="flex items-center justify-between gap-4 text-[11px] border-b border-slate-50 last:border-none pb-0.5">
                                                                    <div className="flex items-center gap-1.5 min-w-0">
                                                                        <div className="w-1 h-1 rounded-full bg-violet-400 shrink-0"></div>
                                                                        <span className="font-bold text-slate-700 truncate">{dt.subjName}</span>
                                                                        <span className="text-slate-400 italic shrink-0">[{dt.className}]</span>
                                                                    </div>
                                                                    <span className="font-black text-slate-500 shrink-0">{dt.jp} JP</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <span className="text-xs text-slate-300 italic">- Tidak Ada Jam Mengajar -</span>
                                                    )}
                                                </td>
                                                <td className="p-4 text-center font-bold text-slate-600">{d.teachingJP}</td>
                                                <td className="p-4">
                                                    <div className="space-y-1">
                                                        {d.ttName && <div className="text-[11px] font-bold text-blue-700 flex items-center justify-between border-b border-slate-50 pb-0.5"><div className="flex items-center gap-1"><Briefcase size={12} className="text-blue-500" /> {d.ttName}</div> <span className="text-blue-600 font-black">{d.ttHours} JP</span></div>}
                                                        {d.picketDay && <div className="text-[11px] font-bold text-amber-700 flex items-center justify-between border-b border-slate-50 pb-0.5"><div className="flex items-center gap-1"><Coffee size={12} className="text-amber-500" /> Piket {d.picketDay}</div> <span className="text-amber-600 font-black">{d.pJP} JP</span></div>}
                                                        {d.pbName && <div className="text-[11px] font-bold text-indigo-700 flex items-center justify-between border-b border-slate-50 pb-0.5"><div className="flex items-center gap-1"><Award size={12} className="text-indigo-500" /> {d.pbName}</div> <span className="text-indigo-600 font-black">{d.pbHours} JP</span></div>}
                                                        {!d.ttName && !d.picketDay && !d.pbName && <span className="text-xs text-slate-300 italic">-</span>}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <div className={`inline-block px-4 py-1.5 rounded-full font-black text-sm border-2 ${d.totalJP >= 24 ? 'bg-emerald-50 text-emerald-600 border-emerald-100 shadow-sm shadow-emerald-50' : 'bg-amber-50 text-amber-600 border-amber-100'}`}>
                                                        {d.totalJP}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                );
            };

            const renderMasterModal = () => {
                if (!isMasterModalOpen || !editMasterItem) return null;

                const { type, data } = editMasterItem;
                const isEdit = !!data;

                const getModalTitle = () => {
                    const prefix = isEdit ? 'Edit Data' : 'Tambah Data';
                    switch (type) {
                        case 'rombel': return `${prefix} Nama Rombel`;
                        case 'mapel': return `${prefix} Mata Pelajaran`;
                        case 'ruang': return `${prefix} Ruang Kelas`;
                        case 'kurikulum': return `${prefix} Kurikulum`;
                        case 'tugas': return `${prefix} Tugas Tambahan`;
                        case 'pembina': return `${prefix} Pembina Ekstra`;
                        case 'pangkat': return `${prefix} Pangkat/Golongan`;
                        default: return prefix;
                    }
                };

                const getIcon = () => {
                    switch (type) {
                        case 'rombel': return <Tag size={20} />;
                        case 'mapel': return <BookOpen size={20} />;
                        case 'ruang': return <Layout size={20} />;
                        case 'kurikulum': return <Layers size={20} />;
                        case 'tugas': return <Briefcase size={20} />;
                        case 'pembina': return <Award size={20} />;
                        case 'pangkat': return <ShieldCheck size={20} />;
                        default: return <Settings size={20} />;
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm no-print">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-in">
                            <div className={`p-4 text-white flex justify-between items-center ${type === 'rombel' ? 'bg-pink-600' :
                                type === 'mapel' ? 'bg-blue-600' :
                                    type === 'ruang' ? 'bg-orange-600' :
                                        type === 'kurikulum' ? 'bg-teal-600' :
                                            type === 'tugas' ? 'bg-cyan-600' :
                                                type === 'pangkat' ? 'bg-emerald-600' : 'bg-lime-600'
                                }`}>
                                <h3 className="font-bold flex items-center gap-2">{getIcon()} {getModalTitle()}</h3>
                                <button onClick={cancelEditMaster} className="hover:bg-black/20 p-1 rounded-full"><X size={20} /></button>
                            </div>

                            <div className="p-6">
                                {(type === 'rombel' || type === 'ruang' || type === 'kurikulum' || type === 'pangkat') && (
                                    <form onSubmit={(e) => {
                                        const setter = type === 'rombel' ? setMasterRombelNames : type === 'ruang' ? setRooms : type === 'kurikulum' ? setCurriculums : setPangkatGolonganList;
                                        const list = type === 'rombel' ? masterRombelNames : type === 'ruang' ? rooms : type === 'kurikulum' ? curriculums : pangkatGolonganList;
                                        handleSaveMasterSimple(e, setter, list, type);
                                    }} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Nama {type === 'rombel' ? 'Rombel' : type === 'ruang' ? 'Ruang' : type === 'kurikulum' ? 'Kurikulum' : 'Pangkat/Gol'}</label>
                                            <input name="val" defaultValue={data?.name || ''} placeholder={`Masukkan nama ${type}...`} className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-slate-400 outline-none font-bold text-slate-700" required autoFocus />
                                        </div>
                                        <div className="flex gap-2 pt-4">
                                            <button type="button" onClick={cancelEditMaster} className="flex-1 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Batal</button>
                                            <button type="submit" className="flex-[2] px-4 py-3 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                                <Save size={18} /> {isEdit ? 'Simpan Perubahan' : 'Tambah Data'}
                                            </button>
                                        </div>
                                    </form>
                                )}

                                {type === 'mapel' && (
                                    <form onSubmit={handleSaveMasterMapel} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Nama Mata Pelajaran</label>
                                            <input name="mapelName" defaultValue={data?.name || ''} placeholder="Contoh: Matematika" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700" required autoFocus />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Kode Singkatan</label>
                                            <input name="mapelCode" defaultValue={data?.code || ''} placeholder="Contoh: MTK" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700" required />
                                        </div>
                                        <div className="flex gap-2 pt-4">
                                            <button type="button" onClick={cancelEditMaster} className="flex-1 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Batal</button>
                                            <button type="submit" className="flex-[2] px-4 py-3 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 shadow-blue-100">
                                                <Save size={18} /> {isEdit ? 'Simpan Perubahan' : 'Tambah Mapel'}
                                            </button>
                                        </div>
                                    </form>
                                )}

                                {(type === 'tugas' || type === 'pembina') && (
                                    <form onSubmit={(e) => {
                                        const setter = type === 'tugas' ? setTugasTambahanList : setPembinaList;
                                        const list = type === 'tugas' ? tugasTambahanList : pembinaList;
                                        handleSaveMasterAssignment(e, setter, list, type);
                                    }} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Nama Jabatan / Kegiatan</label>
                                            <input name="name" defaultValue={data?.name || ''} placeholder="Contoh: Wakil Kepala Sekolah" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-bold text-slate-700" required autoFocus />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Konversi Jam Pelajaran (JP)</label>
                                            <input type="number" name="hours" defaultValue={data?.hours || ''} placeholder="Beban JP per Minggu" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-bold text-slate-700" required />
                                        </div>
                                        <div className="flex gap-2 pt-4">
                                            <button type="button" onClick={cancelEditMaster} className="flex-1 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Batal</button>
                                            <button type="submit" className={`flex-[2] px-4 py-3 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 ${type === 'tugas' ? 'bg-cyan-600 shadow-cyan-100' : 'bg-lime-600 shadow-lime-100'}`}>
                                                <Save size={18} /> {isEdit ? 'Simpan Perubahan' : 'Tambah Data'}
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // Fungsi untuk mendapatkan Judul Halaman
            const getPageTitle = () => {
                switch (activeTab) {
                    case 'dashboard': return 'Dashboard';
                    case 'guru': return 'Data Guru';
                    case 'master_rombel_names': return 'Master Nama Rombel';
                    case 'master_mapel': return 'Master Mata Pelajaran';
                    case 'master_ruang': return 'Master Ruang Kelas';
                    case 'master_kurikulum': return 'Master Kurikulum';
                    case 'master_jam': return 'Pengaturan Jam Pelajaran';
                    case 'master_max_jam': return 'Master Maximal Jam';
                    case 'master_sk': return 'Master SK & Tanggal';
                    case 'master_tugas': return 'Master Tugas Tambahan';
                    case 'master_pembina': return 'Master Pembina Ekstra';
                    case 'master_picket': return 'Master Guru Piket';
                    case 'master_pangkat': return 'Master Pangkat/Golongan';
                    case 'rombel': return 'Data Rombel Sekolah';
                    case 'pembelajaran': return 'Pembagian Tugas Mengajar';
                    case 'piket': return 'Jadwal Guru Piket';
                    case 'recap': return 'Rekapan Pembagian Tugas';
                    case 'schedule': return 'Jadwal Pelajaran';
                    case 'settings': return 'Pengaturan';
                    default: return 'Dashboard';
                }
            }

            // Fungsi Render Content Utama
            const renderContent = () => {
                switch (activeTab) {
                    case 'dashboard': return renderDashboard();
                    case 'guru': return renderGuruTab();
                    case 'master_rombel_names': return renderMasterRombelNames();
                    case 'master_mapel': return renderMasterMapel();
                    case 'master_ruang': return renderMasterRuang();
                    case 'master_kurikulum': return renderMasterKurikulum();
                    case 'master_jam': return renderMasterJam();
                    case 'master_max_jam': return renderMasterMaxJam();
                    case 'master_sk': return renderMasterSK();
                    case 'master_tugas': return renderMasterTugas();
                    case 'master_pembina': return renderMasterPembina();
                    case 'master_picket': return renderMasterPicket();
                    case 'master_pangkat': return renderMasterPangkatGolongan();
                    case 'rombel': return renderRombelTab();
                    case 'pembelajaran': return renderLearningTab();
                    case 'piket': return renderPicketTab();
                    case 'recap': return renderRecapTab();
                    case 'schedule': return renderScheduler();
                    case 'settings': return renderSettingsTab();
                    default: return renderDashboard();
                }
            };

            // Render Sidebar
            const renderSidebar = () => (
                <aside className={`fixed top-0 left-0 h-full bg-slate-900 text-slate-300 flex flex-col z-50 transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} w-64 shadow-xl no-print`}>
                    <div className="h-20 bg-slate-950/30 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20 rotate-3 flex items-center justify-center">
                                <Calendar className="text-white" size={22} />
                            </div>
                            <div>
                                <h1 className="text-lg font-black text-white tracking-tighter uppercase leading-none">{schoolProfile.appName || 'SiJAB'}</h1>
                                <p className="text-[9px] text-blue-400 font-black tracking-widest uppercase mt-1">Sistem Penjadwalan</p>
                            </div>
                        </div>
                        {/* CLOSE BUTTON FOR MOBILE IN SIDEBAR */}
                        <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden text-slate-400 hover:text-white transition-colors">
                            <X size={24} />
                        </button>
                    </div>

                    <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                        <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'dashboard' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><Home size={18} className={activeTab === 'dashboard' ? 'text-white' : 'text-sky-500'} /> Dashboard</button>
                        <button onClick={() => setActiveTab('guru')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'guru' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><Users size={18} className={activeTab === 'guru' ? 'text-white' : 'text-indigo-500'} /> Data Guru</button>
                        <button onClick={() => setActiveTab('rombel')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'rombel' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><GraduationCap size={18} className={activeTab === 'rombel' ? 'text-white' : 'text-emerald-500'} /> Data Rombel</button>
                        <button onClick={() => setActiveTab('pembelajaran')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'pembelajaran' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><BookOpen size={18} className={activeTab === 'pembelajaran' ? 'text-white' : 'text-cyan-400'} /> Pembelajaran</button>
                        <button onClick={() => setActiveTab('piket')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'piket' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><Coffee size={18} className={activeTab === 'piket' ? 'text-white' : 'text-amber-600'} /> Guru Piket</button>
                        <button onClick={() => setActiveTab('recap')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'recap' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><ClipboardList size={18} className={activeTab === 'recap' ? 'text-white' : 'text-violet-500'} /> Rekapan Tugas</button>

                        <div className="pt-2">
                            <button onClick={() => setExpandedMenu(!expandedMenu)} className="w-full flex items-center justify-between px-4 py-2 text-xs uppercase font-bold text-slate-500 hover:text-white transition-colors"><span>Menu Master</span>{expandedMenu ? <ChevronDown size={14} /> : <ChevronRight size={14} />}</button>
                            {expandedMenu && (
                                <div className="pl-4 space-y-1 mt-1">
                                    <button onClick={() => setActiveTab('master_rombel_names')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_rombel_names' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Tag size={16} className="text-pink-500" /> Rombel</button>
                                    <button onClick={() => setActiveTab('master_mapel')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_mapel' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><BookOpen size={16} className="text-blue-500" /> Mata Pelajaran</button>
                                    <button onClick={() => setActiveTab('master_ruang')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_ruang' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Layout size={16} className="text-orange-500" /> Ruang Kelas</button>
                                    <button onClick={() => setActiveTab('master_kurikulum')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_kurikulum' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Layers size={16} className="text-teal-500" /> Kurikulum</button>
                                    <button onClick={() => setActiveTab('master_jam')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_jam' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Clock size={16} className="text-red-500" /> Jam Pelajaran</button>
                                    <button onClick={() => setActiveTab('master_pangkat')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_pangkat' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><ShieldCheck size={16} className="text-emerald-500" /> Pangkat/Gol</button>
                                    <button onClick={() => setActiveTab('master_max_jam')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_max_jam' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><AlertTriangle size={16} className="text-yellow-500" /> Master Max Jam</button>
                                    <button onClick={() => setActiveTab('master_sk')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_sk' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><FileSignature size={16} className="text-purple-500" /> Master SK & Tgl</button>
                                    <button onClick={() => setActiveTab('master_tugas')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_tugas' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Briefcase size={16} className="text-cyan-500" /> Tugas Tambahan</button>
                                    <button onClick={() => setActiveTab('master_pembina')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_pembina' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><Award size={16} className="text-lime-500" /> Master Pembina</button>
                                    <button onClick={() => setActiveTab('master_picket')} className={`w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg transition-all ${activeTab === 'master_picket' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800'}`}><ShieldCheck size={16} className="text-emerald-600" /> Master Piket</button>
                                </div>
                            )}
                        </div>

                        <button onClick={() => setActiveTab('schedule')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'schedule' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><Calendar size={18} className={activeTab === 'schedule' ? 'text-white' : 'text-rose-500'} /> Jadwal Pelajaran</button>
                    </nav>

                    <div className="p-4 border-t border-slate-700 space-y-1">
                        <button onClick={() => setActiveTab('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'settings' ? 'sidebar-active-rainbow' : 'hover:bg-slate-800'}`}><Settings size={18} className={activeTab === 'settings' ? 'text-white' : 'text-slate-400'} /> Pengaturan</button>
                        <button onClick={() => {
                            askConfirm('Apakah Anda yakin ingin keluar dari aplikasi?', () => {
                                setIsExiting(true);
                                setTimeout(() => {
                                    setIsLoggedIn(false);
                                    setIsExiting(false);
                                    showToast('Anda telah berhasil keluar.', 'info');
                                }, 3000);
                            });
                        }} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all hover:bg-red-900/40 text-red-400 font-bold"><LogOut size={18} /> Keluar</button>
                    </div>
                </aside>
            );

            const renderLoginPage = () => {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col overflow-hidden relative font-sans">
                        {/* TOP MARQUEE */}
                        <div className="h-10 bg-indigo-600 flex items-center overflow-hidden border-b border-indigo-500/30 z-20">
                            <div className="whitespace-nowrap animate-marquee flex items-center gap-10">
                                <span className="text-white font-bold text-xs uppercase tracking-[0.2em]">
                                    Selamat Datang di {schoolProfile.appName} - {schoolProfile.name} - Tahun Ajaran {schoolProfile.academicYear} - Silahkan Login Untuk Mengakses Sistem Penjadwalan -
                                </span>
                                <span className="text-white font-bold text-xs uppercase tracking-[0.2em]">
                                    Selamat Datang di {schoolProfile.appName} - {schoolProfile.name} - Tahun Ajaran {schoolProfile.academicYear} - Silahkan Login Untuk Mengakses Sistem Penjadwalan -
                                </span>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col md:flex-row">
                            {/* LEFT: APP NAME & BRANDING */}
                            <div className="hidden md:flex w-full md:w-5/12 bg-gradient-to-br from-purple-900 via-indigo-950 to-pink-900 items-center justify-center p-8 relative overflow-hidden text-center">
                                <div className="absolute top-0 left-0 w-full h-full opacity-30 bg-[radial-gradient(circle_at_20%_20%,_rgba(255,255,255,0.1)_0%,_transparent_50%)]"></div>
                                <div className="absolute -top-24 -left-24 w-72 h-72 bg-pink-500/20 rounded-full blur-[100px]"></div>
                                <div className="absolute -bottom-24 -right-24 w-72 h-72 bg-purple-500/20 rounded-full blur-[100px]"></div>

                                <div className="relative z-10 animate-fade-in-up text-white">
                                    <div className="inline-block p-5 bg-white/10 backdrop-blur-2xl rounded-[2rem] border border-white/20 shadow-2xl rotate-3 mb-6 group transition-transform hover:rotate-0 duration-500">
                                        <Calendar className="text-white group-hover:scale-110 transition-transform duration-500" size={60} />
                                    </div>
                                    <h1 className="text-4xl lg:text-5xl font-black tracking-tighter uppercase leading-none mb-4 drop-shadow-2xl">
                                        {schoolProfile.appName.split(' ')[0]}<br />
                                        <span className="text-pink-400 italic lowercase font-thin">{schoolProfile.appName.split(' ').slice(1).join(' ')}</span>
                                    </h1>
                                    <div className="h-1.5 w-24 bg-gradient-to-r from-pink-500 to-purple-500 mx-auto mb-6 rounded-full shadow-lg shadow-pink-500/20"></div>
                                    <div className="space-y-3">
                                        <p className="text-white/80 font-black text-lg lg:text-xl uppercase tracking-[0.3em] drop-shadow-md">{schoolProfile.name}</p>
                                        <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-white/10 backdrop-blur-md border border-white/20 rounded-full">
                                            <div className="w-2 h-2 bg-pink-400 rounded-full animate-pulse"></div>
                                            <p className="text-white/60 font-bold text-[10px] uppercase tracking-[0.2em]">Premium Edition 2026</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* RIGHT: LOGIN FORM (CARD STYLE) */}
                            <div className="w-full md:w-7/12 flex items-center justify-center p-4 z-10 bg-slate-100 relative overflow-hidden">
                                {/* DYNAMIC BACKGROUND DECORATION */}
                                <div className="absolute top-[10%] right-[10%] w-48 h-48 bg-purple-200/50 rounded-full blur-[80px] animate-pulse"></div>
                                <div className="absolute bottom-[10%] left-[10%] w-48 h-48 bg-pink-200/50 rounded-full blur-[80px] animate-pulse" style={{ animationDelay: '1s' }}></div>

                                {isLoading ? (
                                    <div className="w-full max-w-sm bg-slate-900 rounded-[2rem] p-8 shadow-2xl relative overflow-hidden border border-slate-800">
                                        <div className="flex items-center gap-3 mb-8">
                                            <div className="p-2 bg-indigo-600 rounded-lg animate-pulse"><Database size={20} className="text-white" /></div>
                                            <h3 className="text-white font-black text-sm uppercase tracking-widest">Sistem Sedang Memuat Data...</h3>
                                        </div>

                                        <div className="space-y-4">
                                            <div className="h-40 bg-black/40 rounded-xl p-4 font-mono text-[10px] text-emerald-400 overflow-hidden flex flex-col justify-end">
                                                {copyItems.map((item, i) => (
                                                    <div key={i} className="animate-fade-in flex gap-2">
                                                        <span className="text-slate-600">[{Math.floor(loadingProgress)}%]</span>
                                                        <span>{item}... OK</span>
                                                    </div>
                                                ))}
                                                <div className="text-white animate-pulse mt-2 flex gap-2">
                                                    <span>&gt;</span>
                                                    <span>{loadingText}</span>
                                                </div>
                                            </div>

                                            <div className="space-y-2">
                                                <div className="flex justify-between text-[10px] font-black text-slate-500 uppercase">
                                                    <span>Proses Penyalinan</span>
                                                    <span>{loadingProgress}%</span>
                                                </div>
                                                <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-gradient-to-r from-indigo-600 to-pink-600 transition-all duration-300"
                                                        style={{ width: `${loadingProgress}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="w-full max-w-sm relative animate-fade-in-up">
                                        {/* WELCOME MESSAGE */}
                                        <div className="mb-6 text-center bg-white/60 backdrop-blur-md p-4 rounded-2xl border border-white shadow-sm ring-4 ring-indigo-50">
                                            <p className="text-indigo-600 font-black text-xs uppercase tracking-widest mb-1">Pesan Sistem:</p>
                                            <p className="text-slate-800 font-bold leading-tight">
                                                Hallo Ibu karus kurikulum SMP Negeri 2 Wertamrian,,, silahkan login yuk!
                                            </p>
                                        </div>

                                        <div className="bg-white/90 backdrop-blur-xl rounded-[2rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1)] p-8 relative border border-white">
                                            {/* TRANSPARENT SECURITY LOGO BACKGROUND */}
                                            <div className="absolute top-8 left-1/2 -translate-x-1/2 opacity-[0.03] pointer-events-none text-purple-900">
                                                <ShieldCheck size={200} />
                                            </div>

                                            <div className="text-center relative z-10">
                                                <div className="inline-flex p-4 bg-gradient-to-br from-purple-600 to-pink-600 rounded-[1.5rem] mb-5 shadow-xl shadow-purple-200 animate-bounce-soft">
                                                    <ShieldCheck className="text-white" size={40} />
                                                </div>
                                                <h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase leading-none">Akses Masuk</h2>
                                                <p className="text-slate-400 font-bold text-[10px] uppercase tracking-widest mt-2">Masukkan kredensial anda</p>
                                            </div>

                                            <form className="mt-8 space-y-4 relative z-10" onSubmit={(e) => {
                                                e.preventDefault();
                                                const fd = new FormData(e.target);
                                                const user = fd.get('username');
                                                const pass = fd.get('password');

                                                if (user === adminCredentials.username && pass === adminCredentials.password) {
                                                    setIsEnteringDashboard(true);
                                                    setTimeout(() => {
                                                        setIsLoggedIn(true);
                                                        setIsEnteringDashboard(false);
                                                        showToast('Login Berhasil! Selamat Datang.', 'success');
                                                    }, 3000);
                                                } else {
                                                    showToast('pasword yang anda masukan salah, silahkan menghubungi bpk. Andi Nusatjasi, Terima kasih', 'error');
                                                }
                                            }}>
                                                <div className="space-y-1.5">
                                                    <label className="text-[9px] font-black text-slate-500 uppercase tracking-widest ml-1">Username / NIP Admin</label>
                                                    <div className="relative group">
                                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-purple-600 transition-colors">
                                                            <Users size={18} />
                                                        </div>
                                                        <input name="username" type="text" className="block w-full pl-11 pr-4 py-3.5 bg-slate-50/50 border-2 border-slate-100 rounded-[1rem] text-slate-700 font-bold placeholder:text-slate-300 focus:bg-white focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all text-sm" placeholder="Admin" required />
                                                    </div>
                                                </div>
                                                <div className="space-y-1.5">
                                                    <label className="text-[9px] font-black text-slate-500 uppercase tracking-widest ml-1">Password Sistem</label>
                                                    <div className="relative group">
                                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-purple-600 transition-colors">
                                                            <ShieldCheck size={18} />
                                                        </div>
                                                        <input
                                                            type={showPassword ? "text" : "password"}
                                                            name="password"
                                                            className="block w-full pl-11 pr-11 py-3.5 bg-slate-50/50 border-2 border-slate-100 rounded-[1rem] text-slate-700 font-bold placeholder:text-slate-300 focus:bg-white focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all text-sm"
                                                            placeholder=""
                                                            required
                                                        />
                                                        <button
                                                            type="button"
                                                            onClick={() => setShowPassword(!showPassword)}
                                                            className="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-purple-600 transition-colors focus:outline-none"
                                                        >
                                                            {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                                        </button>
                                                    </div>
                                                </div>
                                                <button type="submit" className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-[1rem] font-black uppercase tracking-widest text-xs shadow-xl shadow-purple-100 transition-all hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-2 mt-4">
                                                    Masuk Sekarang <ChevronRight size={18} className="animate-pulse" />
                                                </button>
                                            </form>

                                            <div className="mt-8 pt-6 border-t border-slate-100 text-center">
                                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Akses Personel Berwenang</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {isEnteringDashboard && (
                                    <div className="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-6 transition-all duration-500">
                                        <div className="text-center space-y-8 animate-fade-in-up">
                                            <div className="relative">
                                                <div className="w-24 h-24 bg-gradient-to-tr from-indigo-600 to-pink-600 rounded-full mx-auto animate-spin p-1">
                                                    <div className="w-full h-full bg-slate-900 rounded-full flex items-center justify-center">
                                                        <ShieldCheck className="text-white animate-pulse" size={40} />
                                                    </div>
                                                </div>
                                                <div className="absolute -top-2 -right-2 w-8 h-8 bg-emerald-500 rounded-full border-4 border-slate-900 flex items-center justify-center animate-bounce">
                                                    <CheckCircle className="text-white" size={16} />
                                                </div>
                                            </div>

                                            <div className="space-y-4">
                                                <h3 className="text-2xl font-black text-white tracking-tight">
                                                    Ibu Amar mohon tunggu sebentar yah...
                                                </h3>
                                                <div className="flex justify-center items-center gap-2">
                                                    <div className="w-2 h-2 bg-indigo-500 rounded-full animate-dot-1"></div>
                                                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-dot-2"></div>
                                                    <div className="w-2 h-2 bg-pink-500 rounded-full animate-dot-3"></div>
                                                </div>
                                            </div>

                                            <p className="text-slate-500 font-bold text-[10px] uppercase tracking-[0.3em] animate-pulse">
                                                Menyiapkan Dashboard Anda
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>


                        {toast.visible && (
                            <div className="fixed inset-0 z-[100] pointer-events-none flex items-center justify-center p-4">
                                <div className={`
                                    flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border animate-bounce-in
                                    ${toast.type === 'error' ? 'bg-red-600 border-red-500 text-white' :
                                        toast.type === 'info' ? 'bg-blue-600 border-blue-500 text-white' :
                                            'bg-emerald-600 border-emerald-500 text-white'}
                                `}>
                                    {toast.type === 'error' ? <AlertCircle size={24} /> : <CheckCircle size={24} />}
                                    <span className="font-bold text-sm tracking-wide">{toast.msg}</span>
                                </div>
                            </div>
                        )}

                        <style>{`
                            @keyframes marquee {
                                0% { transform: translateX(0); }
                                100% { transform: translateX(-50%); }
                            }
                            .animate-marquee {
                                display: inline-flex;
                                animation: marquee 30s linear infinite;
                            }
                            @keyframes fade-in-up {
                                from { opacity: 0; transform: translateY(30px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                            .animate-fade-in-up { animation: fade-in-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
                            @keyframes bounce-soft {
                                0%, 100% { transform: translateY(0); }
                                50% { transform: translateY(-10px); }
                            }
                            .animate-bounce-soft { animation: bounce-soft 3s ease-in-out infinite; }
                            
                            @keyframes dot-bounce {
                                0%, 100% { transform: translateY(0); opacity: 0.3; }
                                50% { transform: translateY(-10px); opacity: 1; }
                            }
                            .animate-dot-1 { animation: dot-bounce 1s infinite 0.1s; }
                            .animate-dot-2 { animation: dot-bounce 1s infinite 0.2s; }
                            .animate-dot-3 { animation: dot-bounce 1s infinite 0.3s; }
                        `}</style>
                    </div>
                );
            };

            if (!isLoggedIn) return renderLoginPage();

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    {renderSidebar()}

                    <main className={`flex-1 flex flex-col h-full bg-gray-50 transition-all duration-300 ${isSidebarOpen ? 'md:ml-64' : 'ml-0'} print:ml-0`}>
                        <header className="h-20 bg-white border-b border-gray-200 flex items-center px-8 justify-between shrink-0 no-print">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-100 rounded-lg text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <Menu size={24} />
                                </button>
                                <h2 className="text-2xl font-bold text-gray-800 tracking-tight">{getPageTitle()}</h2>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right hidden md:block">
                                    <p className="text-sm font-black text-slate-800 uppercase tracking-tight leading-none">{schoolProfile.name}</p>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">TAHUN AJARAN {schoolProfile.academicYear}</p>
                                </div>
                                <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black border-2 border-slate-700 shadow-xl rotate-3">
                                    {schoolProfile.name.charAt(0)}
                                </div>
                                <div className="ml-2 flex flex-col items-center">
                                    <div className={`w-3 h-3 rounded-full ${isSyncing ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500'} shadow-[0_0_10px_rgba(16,185,129,0.5)]`}></div>
                                    <span className="text-[8px] font-black text-slate-400 mt-1 uppercase tracking-tighter">{isSyncing ? 'Sync' : 'Cloud'}</span>
                                </div>
                            </div>
                        </header>
                        <div className="p-8 overflow-y-auto flex-1 print:p-0">{renderContent()}</div>
                    </main>

                    {isExiting && (
                        <div className="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-6 transition-all duration-500">
                            <div className="text-center space-y-8 animate-fade-in-up">
                                <div className="relative">
                                    <div className="w-24 h-24 bg-gradient-to-tr from-pink-600 to-indigo-600 rounded-full mx-auto animate-spin p-1">
                                        <div className="w-full h-full bg-slate-900 rounded-full flex items-center justify-center">
                                            <LogOut className="text-white animate-pulse" size={40} />
                                        </div>
                                    </div>
                                    <div className="absolute -top-2 -right-2 w-8 h-8 bg-red-500 rounded-full border-4 border-slate-900 flex items-center justify-center animate-bounce">
                                        <X className="text-white" size={16} />
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <h3 className="text-2xl font-black text-white tracking-tight">
                                        Sampai jumpa lagi Ibu Amar... Terima kasih!
                                    </h3>
                                    <div className="flex justify-center items-center gap-2">
                                        <div className="w-2 h-2 bg-indigo-500 rounded-full animate-dot-1"></div>
                                        <div className="w-2 h-2 bg-purple-500 rounded-full animate-dot-2"></div>
                                        <div className="w-2 h-2 bg-pink-500 rounded-full animate-dot-3"></div>
                                    </div>
                                </div>

                                <p className="text-slate-500 font-bold text-[10px] uppercase tracking-[0.3em] animate-pulse">
                                    Menutup Sesi Aman
                                </p>
                            </div>
                        </div>
                    )}

                    {renderMasterModal()}

                    {/* MODAL GURU (VIEW & EDIT) */}
                    {guruModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl overflow-hidden animate-scale-in">
                                <div className="bg-indigo-600 p-4 text-white flex justify-between items-center">
                                    <h3 className="font-bold text-lg flex items-center gap-2">
                                        {guruModalMode === 'view' ? <Eye size={20} /> : (selectedGuru ? <Edit2 size={20} /> : <Plus size={20} />)}
                                        {guruModalMode === 'view' ? 'Detail Data Guru' : (selectedGuru ? 'Edit Data Guru' : 'Tambah Guru Baru')}
                                    </h3>
                                    <button onClick={() => setGuruModalOpen(false)} className="hover:bg-indigo-700 p-1 rounded-full"><X size={20} /></button>
                                </div>
                                <form onSubmit={handleSaveGuruEdit} className="p-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap & Gelar</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800 font-bold">{selectedGuru?.name}</div>
                                            ) : (
                                                <input name="name" defaultValue={selectedGuru?.name || ''} className="w-full border p-3 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Contoh: Ahmad, S.Pd" required />
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Kode Singkatan</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800 font-mono font-bold text-indigo-600">{selectedGuru?.code}</div>
                                            ) : (
                                                <input name="code" defaultValue={selectedGuru?.code || ''} className="w-full border p-3 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none font-mono" placeholder="AH" required />
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">NIP</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800">{selectedGuru?.nip || '-'}</div>
                                            ) : (
                                                <input name="nip" defaultValue={selectedGuru?.nip || ''} className="w-full border p-3 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="-" />
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Pangkat/Golongan</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800">{selectedGuru?.rank || '-'}</div>
                                            ) : (
                                                <select name="rank" defaultValue={selectedGuru?.rank || ''} className="w-full border p-3 rounded-xl text-sm font-bold bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                                    <option value="">-- Pilih Pangkat --</option>
                                                    {pangkatGolonganList.map(pg => <option key={pg.id} value={pg.name}>{pg.name}</option>)}
                                                </select>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Tugas Tambahan</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800">{tugasTambahanList.find(t => t.id === selectedGuru?.tugasTambahanId)?.name || '-'}</div>
                                            ) : (
                                                <select name="tugasTambahanId" defaultValue={selectedGuru?.tugasTambahanId || ''} className="w-full border p-3 rounded-xl text-sm font-bold bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                                    <option value="">-- Tidak Ada --</option>
                                                    {tugasTambahanList.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                </select>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Pembina Ekstra</label>
                                            {guruModalMode === 'view' ? (
                                                <div className="p-3 bg-gray-50 border rounded-xl text-gray-800">{pembinaList.find(p => p.id === selectedGuru?.pembinaId)?.name || '-'}</div>
                                            ) : (
                                                <select name="pembinaId" defaultValue={selectedGuru?.pembinaId || ''} className="w-full border p-3 rounded-xl text-sm font-bold bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                                    <option value="">-- Tidak Ada --</option>
                                                    {pembinaList.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                    <div className="mt-8 flex justify-end gap-3 border-t pt-6">
                                        <button type="button" onClick={() => setGuruModalOpen(false)} className="px-6 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all">Tutup</button>
                                        {guruModalMode !== 'view' && (
                                            <button type="submit" className="px-8 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-lg shadow-indigo-100 transition-all active:scale-95">
                                                <Save size={18} /> {selectedGuru ? 'Simpan Perubahan' : 'Tambah Guru'}
                                            </button>
                                        )}
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {rombelViewModalOpen && selectedRombelView && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden animate-scale-in">
                                <div className="bg-emerald-600 p-4 text-white flex justify-between items-center"><h3 className="font-bold text-lg flex items-center gap-2"><Eye size={20} /> Detail Data Rombel</h3><button onClick={() => setRombelViewModalOpen(false)} className="hover:bg-emerald-700 p-1 rounded-full"><X size={20} /></button></div>
                                <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div><label className="block text-gray-500 text-xs font-bold uppercase mb-1">Nama Rombel</label><div className="font-bold text-lg text-gray-800">{selectedRombelView.name}</div></div>
                                        <div><label className="block text-gray-500 text-xs font-bold uppercase mb-1">Tingkat</label><div className="font-medium text-gray-800">Kelas {selectedRombelView.level}</div></div>
                                        <div><label className="block text-gray-500 text-xs font-bold uppercase mb-1">Kurikulum</label><div className="font-medium text-gray-800">{selectedRombelView.curriculum}</div></div>
                                        <div><label className="block text-gray-500 text-xs font-bold uppercase mb-1">Ruang Kelas</label><div className="font-medium text-gray-800 bg-gray-100 inline-block px-2 rounded">{rooms.find(r => r.id === selectedRombelView.roomId)?.name || '-'}</div></div>
                                        <div className="col-span-2"><label className="block text-gray-500 text-xs font-bold uppercase mb-1">Wali Kelas</label><div className="font-bold text-blue-600 text-md border-b pb-1">{teachers.find(t => t.id === selectedRombelView.teacherId)?.name || 'Belum ditentukan'}</div></div>
                                    </div>
                                    <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 mt-4 flex items-start gap-2"><Info size={16} className="mt-0.5 shrink-0" /><p>Untuk melihat detail pembelajaran dan guru pengampu, silahkan tutup jendela ini dan klik tombol <b>"Pembelajaran"</b> di menu utama Rombel.</p></div>
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex justify-end"><button onClick={() => setRombelViewModalOpen(false)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-medium">Tutup</button></div>
                            </div>
                        </div>
                    )}

                    {modalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
                                <div className="bg-blue-600 p-4 text-white flex justify-between items-center"><h3 className="font-bold">Edit Jadwal</h3><button onClick={() => setModalOpen(false)}><X /></button></div>
                                <div className="p-6 space-y-4">
                                    {errorMsg && <div className="bg-red-100 text-red-700 p-2 rounded text-sm">{errorMsg}</div>}
                                    <div><label className="block text-sm font-bold mb-1">Mapel</label><select className="w-full border p-2 rounded" value={formData.subjectId} onChange={e => setFormData({ ...formData, subjectId: e.target.value })}><option value="">- Pilih Mapel -</option>{subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                    <div><label className="block text-sm font-bold mb-1">Guru</label><select className="w-full border p-2 rounded" value={formData.teacherId} onChange={e => setFormData({ ...formData, teacherId: e.target.value })}><option value="">- Pilih Guru -</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                    <div className="flex justify-between pt-4"><button onClick={handleDeleteScheduleSlot} className="text-red-500 font-bold">Kosongkan</button><button onClick={handleSaveSchedule} className="bg-blue-600 text-white px-4 py-2 rounded font-bold">Simpan</button></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {learningModalOpen && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden animate-scale-in border border-blue-500">
                                <div className="bg-blue-600 p-4 text-white flex justify-between items-center shadow-md">
                                    <div><h3 className="font-bold text-xl flex items-center gap-2"><BookOpen size={24} /> Pembelajaran (Alokasi Guru)</h3><p className="text-blue-100 text-sm mt-1">Kelas: {classes.find(c => c.id === activeLearningClass)?.name || '-'} | Kurikulum: {classes.find(c => c.id === activeLearningClass)?.curriculum || '-'}</p></div>
                                    <button onClick={() => setLearningModalOpen(false)} className="hover:bg-blue-700 p-1 rounded-full"><X size={24} /></button>
                                </div>
                                <div className="bg-blue-50 p-2 border-b border-blue-100 text-xs text-blue-800 flex items-center gap-2"><CheckSquare size={14} /> Data yang Anda input di sini akan tersimpan otomatis. Gunakan tombol 'Selesai' untuk menutup.</div>
                                <div className="flex-1 overflow-auto p-0">
                                    <table className="w-full text-sm border-collapse">
                                        <thead className="bg-gray-100 text-gray-700 sticky top-0 z-10 shadow-sm"><tr><th className="p-3 border border-gray-300 text-left min-w-[250px] bg-gray-100 font-bold">Mata Pelajaran</th><th className="p-3 border border-gray-300 text-left min-w-[250px] bg-gray-100 font-bold">PTK (Guru)</th><th className="p-3 border border-gray-300 text-left w-40 bg-gray-100 font-bold">SK Mengajar</th><th className="p-3 border border-gray-300 text-left w-36 bg-gray-100 font-bold">Tgl SK</th><th className="p-3 border border-gray-300 text-center w-20 bg-gray-100 font-bold">Jam</th><th className="p-3 border border-gray-300 text-center w-20 bg-gray-100 font-bold">Max</th></tr></thead>
                                        <tbody className="divide-y divide-gray-200 bg-white">
                                            {subjects.map((subject, idx) => {
                                                const alloc = allocations.find(a => a.classId === activeLearningClass && a.subjectId === subject.id) || {};
                                                const currentMax = maxHourSettings[subject.id] || 0;
                                                return (
                                                    <tr key={subject.id} className="hover:bg-blue-50 transition-colors">
                                                        <td className="p-2 border border-gray-300"><div className="font-bold text-gray-800">{subject.name}</div><div className="text-xs text-gray-500">{subject.code}</div></td>
                                                        <td className="p-2 border border-gray-300"><select className="w-full border border-gray-300 p-2 rounded focus:ring-2 ring-blue-500 outline-none bg-white text-gray-700" value={alloc.teacherId || ''} onChange={(e) => handleUpdateAllocation(subject.id, 'teacherId', e.target.value)}><option value="">-- Pilih PTK --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></td>
                                                        <td className="p-2 border border-gray-300"><input type="text" className="w-full border border-gray-300 p-2 rounded focus:ring-2 ring-blue-500 outline-none" placeholder="No. SK" value={alloc.skNumber || masterSK.number || ''} onChange={(e) => handleUpdateAllocation(subject.id, 'skNumber', e.target.value)} /></td>
                                                        <td className="p-2 border border-gray-300"><input type="date" className="w-full border border-gray-300 p-2 rounded focus:ring-2 ring-blue-500 outline-none text-gray-600" value={alloc.skDate || masterSK.date || ''} onChange={(e) => handleUpdateAllocation(subject.id, 'skDate', e.target.value)} /></td>
                                                        <td className="p-2 border border-gray-300 text-center"><input type="number" className="w-full border border-gray-300 p-2 rounded focus:ring-2 ring-blue-500 outline-none text-center font-bold text-gray-700" placeholder="0" value={alloc.hours || ''} onChange={(e) => handleUpdateAllocation(subject.id, 'hours', e.target.value)} /></td>
                                                        <td className="p-2 border border-gray-300 text-center bg-gray-50"><div className="font-bold text-gray-500 text-center">{currentMax > 0 ? currentMax : '-'}</div></td>
                                                    </tr>
                                                )
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex justify-end gap-3"><button onClick={() => setLearningModalOpen(false)} className="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-100">Batal</button><button onClick={() => setLearningModalOpen(false)} className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 flex items-center gap-2"><CheckCircle size={18} /> Selesai</button></div>
                            </div>
                        </div>
                    )}

                    {/* CUSTOM NOTIFICATION TOAST */}
                    {toast.visible && (
                        <div className="fixed inset-0 z-[100] pointer-events-none flex items-center justify-center p-4">
                            <div className={`
                                flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border animate-bounce-in
                                ${toast.type === 'error' ? 'bg-red-600 border-red-500 text-white' :
                                    toast.type === 'info' ? 'bg-blue-600 border-blue-500 text-white' :
                                        'bg-emerald-600 border-emerald-500 text-white'}
                            `}>
                                {toast.type === 'error' ? <AlertCircle size={24} /> : <CheckCircle size={24} />}
                                <span className="font-bold text-sm tracking-wide">{toast.msg}</span>
                            </div>
                        </div>
                    )}

                    {/* CUSTOM CONFIRMATION MODAL */}
                    {confirmModal.visible && (
                        <div className="fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale-in border border-slate-200">
                                <div className="p-6 text-center space-y-4">
                                    <div className="mx-auto w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center text-amber-500 border border-amber-100">
                                        <AlertTriangle size={32} />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-800">Konfirmasi Tindakan</h3>
                                        <p className="text-sm text-slate-500 mt-2 leading-relaxed">{confirmModal.message}</p>
                                    </div>
                                    <div className="flex gap-3 pt-4">
                                        <button onClick={closeConfirm} className="flex-1 px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-bold transition-all">Batal</button>
                                        <button onClick={() => { confirmModal.onConfirm(); closeConfirm(); }} className="flex-1 px-4 py-2.5 bg-indigo-600 hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 transition-all active:scale-95 text-xs uppercase tracking-wider">Lanjutkan</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <style>{`
                        @keyframes scale-in {
                            from { opacity: 0; transform: scale(0.9) translateY(20px); }
                            to { opacity: 1; transform: scale(1) translateY(0); }
                        }
                        @keyframes bounce-in {
                            0% { opacity: 0; transform: scale(0.3) translateY(40px); }
                            50% { opacity: 1; transform: scale(1.05) translateY(-5px); }
                            70% { transform: scale(0.9) translateY(2px); }
                            100% { transform: scale(1) translateY(0); }
                        }
                        .animate-scale-in { animation: scale-in 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
                        .animate-bounce-in { animation: bounce-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

                        @keyframes rainbow-sidebar {
                            0% { background-position: 0% 50%; }
                            50% { background-position: 100% 50%; }
                            100% { background-position: 0% 50%; }
                        }
                        .sidebar-active-rainbow {
                            background: linear-gradient(270deg, #2563eb, #7c3aed, #db2777, #2563eb);
                            background-size: 400% 400%;
                            animation: rainbow-sidebar 4s ease infinite;
                            color: white !important;
                            font-weight: 900 !important;
                            box-shadow: 0 4px 15px -1px rgba(37, 99, 235, 0.4);
                        }

                        @media print {
                            @page { size: auto; margin: 10mm; }
                            .no-print { display: none !important; }
                            body { background: white; margin: 0; padding: 0; width: 100%; }
                            
                            /* Force main container to full width */
                            #root, main, .container, .animate-fade-in { 
                                margin-left: 0 !important; 
                                padding-left: 0 !important;
                                padding-right: 0 !important;
                                width: 100% !important; 
                                max-width: 100% !important;
                                position: static !important;
                                transform: none !important;
                            }
                            
                            /* Table specific fix */
                            table { 
                                border: 1px solid #000; 
                                border-collapse: collapse !important;
                                width: 100% !important; 
                                table-layout: auto !important;
                                font-size: 9pt !important;
                            }
                            th, td { 
                                border: 1px solid #000 !important; 
                                padding: 4px 6px !important;
                                color: #000 !important;
                                word-break: break-word !important;
                            }
                            
                            /* Visual cleanup */
                            .shadow-sm, .shadow-md, .shadow-lg, .shadow-xl, .shadow-2xl { box-shadow: none !important; }
                            .rounded-xl, .rounded-2xl { border-radius: 0 !important; border: 1px solid #e2e8f0 !important; }
                            .bg-slate-50, .bg-gray-50, .bg-blue-50, .bg-white { background-color: transparent !important; }
                            
                            /* Prevent cut off in long tables */
                            tr { page-break-inside: avoid; }
                            thead { display: table-header-group; }
                        }
                    `}</style>
                </div>
            );
        }

        // Mount App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>

    <!-- Babel for JSX support in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

</body>

</html>
